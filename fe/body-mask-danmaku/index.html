<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web 端基于机器学习实现防档（不挡脸）弹幕 | 风痕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="...">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.5bdd650a.js" as="script"><link rel="preload" href="/assets/js/2.f69a5113.js" as="script"><link rel="preload" href="/assets/js/3.b1eb6805.js" as="script"><link rel="prefetch" href="/assets/js/10.5c2bb7c0.js"><link rel="prefetch" href="/assets/js/11.a9e937f3.js"><link rel="prefetch" href="/assets/js/12.18e1a8d3.js"><link rel="prefetch" href="/assets/js/13.086c173f.js"><link rel="prefetch" href="/assets/js/14.ba45a4c1.js"><link rel="prefetch" href="/assets/js/15.3332d864.js"><link rel="prefetch" href="/assets/js/16.a62b9621.js"><link rel="prefetch" href="/assets/js/17.df315171.js"><link rel="prefetch" href="/assets/js/18.2a0aea87.js"><link rel="prefetch" href="/assets/js/19.723e65fd.js"><link rel="prefetch" href="/assets/js/20.530ad6f9.js"><link rel="prefetch" href="/assets/js/21.3d3402c7.js"><link rel="prefetch" href="/assets/js/22.d9c40d56.js"><link rel="prefetch" href="/assets/js/23.f4ca2db8.js"><link rel="prefetch" href="/assets/js/24.42966d79.js"><link rel="prefetch" href="/assets/js/25.acb12a54.js"><link rel="prefetch" href="/assets/js/26.e42497f5.js"><link rel="prefetch" href="/assets/js/27.2a48814c.js"><link rel="prefetch" href="/assets/js/28.b9a1fa55.js"><link rel="prefetch" href="/assets/js/29.fc3b3ec7.js"><link rel="prefetch" href="/assets/js/30.8aa1373a.js"><link rel="prefetch" href="/assets/js/31.064b6ef6.js"><link rel="prefetch" href="/assets/js/32.2d7f9391.js"><link rel="prefetch" href="/assets/js/33.da7b40ae.js"><link rel="prefetch" href="/assets/js/34.48af420a.js"><link rel="prefetch" href="/assets/js/35.b5212b6b.js"><link rel="prefetch" href="/assets/js/36.6e4b1ce2.js"><link rel="prefetch" href="/assets/js/37.7815b84c.js"><link rel="prefetch" href="/assets/js/38.22e0cdb1.js"><link rel="prefetch" href="/assets/js/39.467f0eff.js"><link rel="prefetch" href="/assets/js/4.46ad5bf7.js"><link rel="prefetch" href="/assets/js/5.279f05c1.js"><link rel="prefetch" href="/assets/js/6.9361dec1.js"><link rel="prefetch" href="/assets/js/7.3cafae79.js"><link rel="prefetch" href="/assets/js/8.a2fdc4e3.js"><link rel="prefetch" href="/assets/js/9.fe737b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">风痕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端基础课程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-basic-course/js-lang-history-and-basic.html" class="sidebar-link">JS语言历史及基本特性介绍</a></li><li><a href="/fe-basic-course/js-data-process/" class="sidebar-link">JS数据处理</a></li><li><a href="/fe-basic-course/ts-types-system.html" class="sidebar-link">系统化学习 TS 类型系统</a></li><li><a href="/fe-basic-course/js-concurrent.html" class="sidebar-link">JS 多线程并发</a></li><li><a href="/fe-basic-course/https-brief/https-brief.html" class="sidebar-link">HTTPS加密原理简介</a></li><li><a href="/fe-basic-course/options-request.html" class="sidebar-link">Options请求介绍及应对</a></li><li><a href="/fe-basic-course/timer-delay.html" class="sidebar-link">JS 定时器延迟时长细节</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端杂货</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/vuepress-gitment.html" class="sidebar-link">VuePress 集成第三方评论模块</a></li><li><a href="/fe/canvas-lib/" class="sidebar-link">Mini Canvas Lib 核心交互实现原理</a></li><li><a href="/fe/body-mask-danmaku/" aria-current="page" class="active sidebar-link">Web 端基于机器学习实现防档（不挡脸）弹幕</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#选择机器学习模型" class="sidebar-link">选择机器学习模型</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#降低提取频率，平衡-性能-体验" class="sidebar-link">降低提取频率，平衡 性能-体验</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#解决性能瓶颈代码" class="sidebar-link">解决性能瓶颈代码</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#降低分辨率" class="sidebar-link">降低分辨率</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#启动条件优化" class="sidebar-link">启动条件优化</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#发布构建优化" class="sidebar-link">发布构建优化</a></li><li class="sidebar-sub-header"><a href="/fe/body-mask-danmaku/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/fe/js-perf-detect.html" class="sidebar-link">JS 检测设备性能</a></li><li><a href="/fe/react-hooks/" class="sidebar-link">react hooks的思考</a></li><li><a href="/fe/thinking-miniprogram.html" class="sidebar-link">小程序的思考</a></li><li><a href="/fe/modularization/" class="sidebar-link">前端模块化设计</a></li><li><a href="/fe/vue-directive-track.html" class="sidebar-link">基于vue directive实现声明式埋点方案</a></li><li><a href="/fe/bug1-safari10.html" class="sidebar-link">BUG: Safari10 Cannot declare a let variable twice: 'e'.</a></li><li><a href="/fe/sw-ssr/" class="sidebar-link">同构项目 Service Worker 离线化实践</a></li><li><a href="/fe/run-web-project-in-termux.html" class="sidebar-link">在Termux中运行web项目</a></li><li><a href="/fe/debug-hover-element/" class="sidebar-link">调试鼠标悬浮（hover）元素的css技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/cljs-node-hotreload.html" class="sidebar-link">ClojureScript + node + hotreload</a></li><li><a href="/clojure/cljs-transient-performance.html" class="sidebar-link">cljs中普通与瞬态数据结构性能对比</a></li><li><a href="/clojure/shadow-cljs-proto-repl.html" class="sidebar-link">shadow-cljs项目 在 proto repl 切换namespace</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随想</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/think/dao.html" class="sidebar-link">天道</a></li><li><a href="/think/biosphere/" class="sidebar-link">生存空间</a></li><li><a href="/think/book-review.html" class="sidebar-link">书评笔记</a></li><li><a href="/think/qin/" class="sidebar-link">为何是秦灭六国，统一天下</a></li><li><a href="/think/interview.html" class="sidebar-link">技术面试中的“运气”指什么</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="web-端基于机器学习实现防档（不挡脸）弹幕"><a href="#web-端基于机器学习实现防档（不挡脸）弹幕" class="header-anchor">#</a> Web 端基于机器学习实现防档（不挡脸）弹幕</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p><strong>防档弹幕</strong>，即大量弹幕飘过，但不会遮挡视频画面中的人物，看起来像是从人物背后飘过去的。<br> <img src="/assets/img/bili-mask-danmaku.d2c8b546.jpeg" width="400"></p> <h3 id="主流实现原理"><a href="#主流实现原理" class="header-anchor">#</a> 主流实现原理</h3> <h4 id="点播"><a href="#点播" class="header-anchor">#</a> 点播</h4> <ol><li>up 上传视频</li> <li>服务器后台计算提取视频画面中的人像区域，转换成 svg 存储</li> <li>客户端播放视频的同时，从服务器下载 svg 与弹幕合成，人像区域不显示弹幕</li></ol> <h4 id="直播"><a href="#直播" class="header-anchor">#</a> 直播</h4> <ol><li>主播推流时，实时（主播设备）从画面提取人像区域，转换成 svg</li> <li>将 svg 数据合并到视频流中（SEI），推流至服务器</li> <li>客户端播放视频同时，从视频流中（SEI）解析出 svg</li> <li>将 svg 与弹幕合成，人像区域不显示弹幕</li></ol> <h3 id="本文实现方案"><a href="#本文实现方案" class="header-anchor">#</a> 本文实现方案</h3> <ol><li>客户端播放视频同时，实时从画面提取人像区域信息</li> <li>将人像区域信息导出成图片，与弹幕合成，人像区域不显示弹幕</li></ol> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <ol><li>采用机器学习开源库从视频画面实时提取人像轮廓，如<a href="https://github.com/tensorflow/tfjs-models/blob/master/body-segmentation/README.md" target="_blank" rel="noopener noreferrer">Body Segmentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>将人像轮廓转导出为图片，设置弹幕层的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/mask-image" target="_blank" rel="noopener noreferrer">mask-image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h4 id="面临的问题"><a href="#面临的问题" class="header-anchor">#</a> 面临的问题</h4> <p>众所周知“<em>JS 性能太辣鸡</em>”，不适合执行 CPU 密集型任务。</p> <p>一开始我也不敢相信实时计算，能将 <strong>CPU 占用优化到 <span style="color:red;">5%</span> 左右</strong>（2020 M1 Macbook）<br>
甚至低于主流实现中，单在客户端上的性能损耗（解析 svg，与弹幕合成）</p> <hr> <p>------------------------------ 正片开始，以下是调优过程 ------------------------------</p> <hr> <h2 id="选择机器学习模型"><a href="#选择机器学习模型" class="header-anchor">#</a> 选择机器学习模型</h2> <details><summary><span style="color:#1989fa;cursor:pointer;">可展开</span> <p><a href="https://github.com/tensorflow/tfjs-models/blob/master/body-segmentation/src/body_pix/README.md" target="_blank" rel="noopener noreferrer">BodyPix<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <strong>X</strong><br>
精确度太差，有很明显的弹幕与面部重合现象</p></summary> <img src="/assets/img/bodypix-mask.b283275f.png"></details> <details><summary><span style="color:#1989fa;cursor:pointer;">可展开</span> <p><a href="https://github.com/tensorflow/tfjs-models/blob/master/pose-detection/src/blazepose_mediapipe/README.md" target="_blank" rel="noopener noreferrer">BlazePose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><strong>X</strong><br>
精确度跟后面的MediaPipe SelfieSegmentation差不多，因为提供了肢体点位信息，<strong>CPU 占用相对高出 15% 左右</strong></p></summary> <img src="/assets/img/blacepose-mask.0c65af60.png"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    score<span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
    keypoints<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">230</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">220</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token number">0.9</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token number">0.99</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&quot;nose&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">212</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">190</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token number">0.91</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&quot;left_eye&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    keypoints3D<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">0.65</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0.11</span><span class="token punctuation">,</span> z<span class="token operator">:</span> <span class="token number">0.05</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token number">0.99</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&quot;nose&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    segmentation<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">maskValueToLabel</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">maskValue<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">'person'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      mask<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">toCanvasImageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
        <span class="token function">toImageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
        <span class="token function">toTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
        <span class="token function">getUnderlyingType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div></details> <details><summary><span style="color:#1989fa;cursor:pointer;">可展开</span> <p><a href="https://github.com/tensorflow/tfjs-models/blob/master/body-segmentation/src/selfie_segmentation_mediapipe/README.md" target="_blank" rel="noopener noreferrer">MediaPipe SelfieSegmentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <strong>√</strong><br>
精确度优秀，只提供了人像区域信息，性能取胜</p></summary> <img src="/assets/img/bodysegment-mask.f526046f.png"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token function-variable function">maskValueToLabel</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">maskValue<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">'person'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mask<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">toCanvasImageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
    <span class="token function">toImageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
    <span class="token function">toTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
    <span class="token function">getUnderlyingType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <hr> <p>参考<a href="https://github.com/tensorflow/tfjs-models/blob/master/body-segmentation/README.md#bodysegmentationdrawmask" target="_blank" rel="noopener noreferrer">官方实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，未做优化的情况下
<strong><span style="color:red;">CPU 占用 70% 左右</span></strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>videoWidth
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>videoHeight
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">detect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> segmentation <span class="token operator">=</span> <span class="token keyword">await</span> segmenter<span class="token punctuation">.</span><span class="token function">segmentPeople</span><span class="token punctuation">(</span>videoEl<span class="token punctuation">)</span>
  <span class="token keyword">const</span> foregroundColor <span class="token operator">=</span> <span class="token punctuation">{</span> r<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> g<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> backgroundColor <span class="token operator">=</span> <span class="token punctuation">{</span> r<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> g<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token number">255</span> <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mask <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">toBinaryMask</span><span class="token punctuation">(</span>segmentation<span class="token punctuation">,</span> foregroundColor<span class="token punctuation">,</span> backgroundColor<span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">drawMask</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> canvas<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
  <span class="token comment">// 导出Mask图片，需要的是轮廓，图片质量设为最低</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>detect<span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">detect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token builtin">console</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span>
</code></pre></div><h2 id="降低提取频率，平衡-性能-体验"><a href="#降低提取频率，平衡-性能-体验" class="header-anchor">#</a> 降低提取频率，平衡 性能-体验</h2> <p>一般视频 30FPS，尝试弹幕遮罩（后称 Mask）刷新频率降为 15FPS，体验上还能接受<br> <em>（再低就影响体验了）</em></p> <div class="language-ts extra-class"><pre class="language-ts"><code>window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>detect<span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span> <span class="token comment">// 33 =&gt; 66</span>
</code></pre></div><p>此时，<strong><span style="color:red;">CPU 占用 50% 左右</span></strong></p> <h2 id="解决性能瓶颈代码"><a href="#解决性能瓶颈代码" class="header-anchor">#</a> 解决性能瓶颈代码</h2> <img src="/assets/img/flame-graph.5f5ace85.png"> <p>分析火焰图可发现，性能瓶颈在 <code>toBinaryMask</code> 和 <code>toDataURL</code></p> <h3 id="重写tobinarymask"><a href="#重写tobinarymask" class="header-anchor">#</a> 重写toBinaryMask</h3> <p>分析源码，结合打印<code>segmentation</code>的信息，发现<code>segmentation.mask.toCanvasImageSource</code>可获取原始<code>ImageBitmap</code>对象，即是模型提取出来的信息。<br>
尝试自行实现将<code>ImageBitmap</code>转换成 Mask 的能力，替换开源库提供的默认实现。</p> <p><strong>实现原理</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">detect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> segmentation <span class="token operator">=</span> <span class="token keyword">await</span> segmenter<span class="token punctuation">.</span><span class="token function">segmentPeople</span><span class="token punctuation">(</span>videoEl<span class="token punctuation">)</span>

  context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
  <span class="token comment">// 1. 将`ImageBitmap`绘制到 Canvas 上</span>
  context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
    <span class="token comment">// 经验证 即使出现多人，也只有一个 segmentation</span>
    <span class="token keyword">await</span> segmentation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mask<span class="token punctuation">.</span><span class="token function">toCanvasImageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
    canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height
  <span class="token punctuation">)</span>
  <span class="token comment">// 2. 设置混合模式</span>
  context<span class="token punctuation">.</span>globalCompositeOperation <span class="token operator">=</span> <span class="token string">'source-out'</span>
  <span class="token comment">// 3. 反向填充黑色</span>
  context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
  <span class="token comment">// 导出Mask图片，需要的是轮廓，图片质量设为最低</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

  window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>detect<span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第 2、3 步相当于给人像区域外的内容填充黑色（反向填充<code>ImageBitmap</code>），是为了配合css（mask-image），
不然只有当弹幕飘到人像区域才可见（与目标效果正好相反）。<br> <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation" target="_blank" rel="noopener noreferrer">globalCompositeOperation MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>此时，<strong><span style="color:red;">CPU 占用 33% 左右</span></strong></p> <h3 id="多线程优化"><a href="#多线程优化" class="header-anchor">#</a> 多线程优化</h3> <p>只剩下<code>toDataURL</code>这个耗时操作了，本以为<code>toDataURL</code>是浏览器内部实现，无法再进行优化了。<br>
虽没有替换实现，但可使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas" target="_blank" rel="noopener noreferrer">OffscreenCanvas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> + Worker，将耗时任务转移到 Worker 中去，
避免占用主线程，就不会影响用户体验了。<br>
并且<code>ImageBitmap</code>实现了<code>Transferable</code>接口，可被转移所有权，<a href="/fe-basic-course/js-concurrent.html#两个方法对比">跨 Worker 传递也没有性能损耗</a>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 前文 detect 的反向填充 ImageBitmap 也可以转移到 Worker 中</span>
<span class="token comment">// 用 OffscreenCanvas 实现， 此处略过</span>

<span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReaderSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// OffscreenCanvas 不支持 toDataURL，使用 convertToBlob 代替</span>
offsecreenCvsEl<span class="token punctuation">.</span><span class="token function">convertToBlob</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'image/png'</span><span class="token punctuation">,</span>
  quality<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">blob</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dataURL <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    msgType<span class="token operator">:</span> <span class="token string">'mask'</span><span class="token punctuation">,</span>
    val<span class="token operator">:</span> dataURL
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token builtin">console</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span>
</code></pre></div><img src="/assets/img/flame-graph-2.87a27c93.png"> <p>可以看到两个耗时的操作消失了<br>
此时，<strong><span style="color:red;">CPU 占用 15% 左右</span></strong></p> <h2 id="降低分辨率"><a href="#降低分辨率" class="header-anchor">#</a> 降低分辨率</h2> <p>继续分析，上图重新计算样式（紫色部分）耗时约 3ms<br>
Demo 足够简单很容易推测到是这行代码导致的，发现 <code>imgStr</code> 大概 100kb 左右（视频分辨率 1280x720）。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>danmakuContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitMaskImage <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>imgStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p><strong>优化实现</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 拉伸 mask-image</span>
danmakuContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitMaskSize <span class="token operator">=</span> <span class="token string">'100%, 100%'</span> 

<span class="token keyword">const</span> cvsEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span>
<span class="token comment">// 将宽度缩小至 300 像素 </span>
<span class="token keyword">const</span> approWidth <span class="token operator">=</span> <span class="token number">300</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>videoEl<span class="token punctuation">.</span>videoWidth <span class="token operator">&gt;</span> approWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cvsEl<span class="token punctuation">.</span>width <span class="token operator">=</span> approWidth
  <span class="token comment">// 保持比例</span>
  cvsEl<span class="token punctuation">.</span>height <span class="token operator">=</span> videoEl<span class="token punctuation">.</span>videoHeight <span class="token operator">*</span> approWidth <span class="token operator">/</span> videoEl<span class="token punctuation">.</span>videoWidth
<span class="token punctuation">}</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> cvsEl<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">detect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 缩小视频</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>videoEl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cvsEl<span class="token punctuation">.</span>width<span class="token punctuation">,</span> cvsEl<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
  <span class="token comment">// 提取 Mask，使用缩小的 cvsEl 代替 videoEl</span>
  <span class="token keyword">const</span> segmention <span class="token operator">=</span> <span class="token keyword">await</span> segmenter<span class="token punctuation">.</span><span class="token function">segmentPeople</span><span class="token punctuation">(</span>cvsEl<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>优化后，导出的 <code>imgStr</code> 大概 12kb，重新计算样式耗时约 0.5ms。<br>
此时，<strong><span style="color:red;">CPU 占用 5% 左右</span></strong></p> <img src="/assets/img/cpu.421e0e6e.gif" style="box-shadow:2px 2px 10px;"> <h2 id="启动条件优化"><a href="#启动条件优化" class="header-anchor">#</a> 启动条件优化</h2> <p>虽然提取 Mask 整个过程的 CPU 占用已优化到可喜程度。<br>
当在画面没人的时候，或没有弹幕时候，可以停止计算，实现 0 CPU 占用。</p> <p><em>无弹幕判断比较简单（比如 10s 内收超过两条弹幕则启动计算），也不在该 SDK 实现范围，略过</em></p> <p><strong>判定画面是否有人</strong><br>
第一步中为了高性能，选择的模型只有<code>ImageBitmap</code>，并没有提供肢体点位信息。<br>
所以只能使用<code>ImageBitmap</code>来判断是否有人。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> dataURL <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
<span class="token comment">// postMessage...</span>

<span class="token keyword">const</span> hasBody <span class="token operator">=</span> <span class="token function">checkHasBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token comment">// undfined 表示本次被节流，未进行检测</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// postMessage 告诉主线程 逐渐降低检测频率，[1, 3, 5]秒 检测一次</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkHasBody</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> imgData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> imgW<span class="token punctuation">,</span> imgH<span class="token punctuation">)</span>
  <span class="token comment">// imgData 是 Uint8ArrayBuffer, 每个像素 4 字节 [r, g, b, a]</span>
  <span class="token comment">// 转成 Uint32Array 相当于一个像素点对应一个比较大的整数</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>imgData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> img<span class="token punctuation">.</span>length
  <span class="token comment">// 从中间开始检测，人像在中间的几率更高</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> maxDistance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&gt;</span> maxDistance<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token comment">// 某个像素值为 0 表示该像素点透明 { r:0, g:0, b:0, a:0 }</span>
    <span class="token comment">// 说明该点是人像区域内的一个点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>p <span class="token operator">+</span> distance<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>img<span class="token punctuation">[</span>p <span class="token operator">-</span> distance<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>

    <span class="token comment">// 从中间开始分别向左右跳跃检测</span>
    <span class="token comment">// 人像区域是连续的，每次跳 10 像素，提升性能也不会误判</span>
    distance <span class="token operator">+=</span> <span class="token number">10</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>画面无人时，<strong><span style="color:red;">CPU 占用接近 0%</span></strong></p> <h2 id="发布构建优化"><a href="#发布构建优化" class="header-anchor">#</a> 发布构建优化</h2> <p>虽然优化耗时较长，完整的代码差不多 200 行，核心代码都贴出来了。<br>
但依赖包的提交较大，构建出的 bundle 体积：<code>684.75 KiB / gzip: 125.83 KiB</code></p> <p>所以，可以进行异步加载SDK，提升页面加载性能。</p> <ol><li>分别打包一个 loader，一个主体</li> <li>由业务方 import loader，首次启用时异步加载主体</li></ol> <p>这个两步前端工程已经非常成熟了，略过细节。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <h3 id="过程"><a href="#过程" class="header-anchor">#</a> 过程</h3> <ul><li>选择高性能模型后，初始状态 CPU 70%</li> <li>降低 Mask 刷新频率（15FPS），CPU 50%</li> <li>重写开源库实现（toBinaryMask），CPU 33%</li> <li>多线程优化，CPU 15%</li> <li>降低分辨率，CPU 5%</li> <li>判断画面是否有人，无人时 CPU 接近 0%</li></ul> <p><em>CPU 数值指主线程占用</em></p> <h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ul><li><strong>兼容性</strong>：Chrome 79及以上，不支持 Firefox、Safari。因为使用了<code>OffsccenCanvas</code></li> <li>不应创建多个或多次创建<code>segmenter</code>实例（bodySegmentation.createSegmenter），如需复用请保存实例引用，因为：
<ul><li>创建实例时低性能设备会有明显的卡顿现象</li> <li>会内存泄露；如果无可避免，这是<a href="https://github.com/google/mediapipe/issues/2819#issuecomment-1160335349" target="_blank" rel="noopener noreferrer">mediapipe 内存泄露 解决方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <h3 id="经验"><a href="#经验" class="header-anchor">#</a> 经验</h3> <ul><li>优化完成之后，提取并应用 Mask 关键计算量在 GPU (30%左右)，而不是 CPU</li> <li>性能优化需要业务场景分析，防档弹幕场景可以使用低分辨率、低刷新率的 mask-image，能大幅减少计算量</li> <li>该方案其他应用场景：
<ul><li>替换/模糊人物背景</li> <li>人像马赛克</li> <li>人像抠图</li> <li>卡通头套，虚拟饰品，如猫耳朵、兔耳朵、带花、戴眼镜什么的（换一个模型，略改）</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe/canvas-lib/" class="prev">
        Mini Canvas Lib 核心交互实现原理
      </a></span> <span class="next"><a href="/fe/js-perf-detect.html">
        JS 检测设备性能
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdd650a.js" defer></script><script src="/assets/js/2.f69a5113.js" defer></script><script src="/assets/js/3.b1eb6805.js" defer></script>
  </body>
</html>
