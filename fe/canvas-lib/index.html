<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mini Canvas Lib 核心交互实现原理 | 风痕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="...">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.5bdd650a.js" as="script"><link rel="preload" href="/assets/js/2.f69a5113.js" as="script"><link rel="preload" href="/assets/js/5.279f05c1.js" as="script"><link rel="prefetch" href="/assets/js/10.5c2bb7c0.js"><link rel="prefetch" href="/assets/js/11.a9e937f3.js"><link rel="prefetch" href="/assets/js/12.18e1a8d3.js"><link rel="prefetch" href="/assets/js/13.086c173f.js"><link rel="prefetch" href="/assets/js/14.ba45a4c1.js"><link rel="prefetch" href="/assets/js/15.3332d864.js"><link rel="prefetch" href="/assets/js/16.a62b9621.js"><link rel="prefetch" href="/assets/js/17.df315171.js"><link rel="prefetch" href="/assets/js/18.2a0aea87.js"><link rel="prefetch" href="/assets/js/19.723e65fd.js"><link rel="prefetch" href="/assets/js/20.530ad6f9.js"><link rel="prefetch" href="/assets/js/21.3d3402c7.js"><link rel="prefetch" href="/assets/js/22.d9c40d56.js"><link rel="prefetch" href="/assets/js/23.f4ca2db8.js"><link rel="prefetch" href="/assets/js/24.42966d79.js"><link rel="prefetch" href="/assets/js/25.acb12a54.js"><link rel="prefetch" href="/assets/js/26.e42497f5.js"><link rel="prefetch" href="/assets/js/27.2a48814c.js"><link rel="prefetch" href="/assets/js/28.b9a1fa55.js"><link rel="prefetch" href="/assets/js/29.fc3b3ec7.js"><link rel="prefetch" href="/assets/js/3.b1eb6805.js"><link rel="prefetch" href="/assets/js/30.8aa1373a.js"><link rel="prefetch" href="/assets/js/31.064b6ef6.js"><link rel="prefetch" href="/assets/js/32.2d7f9391.js"><link rel="prefetch" href="/assets/js/33.da7b40ae.js"><link rel="prefetch" href="/assets/js/34.48af420a.js"><link rel="prefetch" href="/assets/js/35.b5212b6b.js"><link rel="prefetch" href="/assets/js/36.6e4b1ce2.js"><link rel="prefetch" href="/assets/js/37.7815b84c.js"><link rel="prefetch" href="/assets/js/38.22e0cdb1.js"><link rel="prefetch" href="/assets/js/39.467f0eff.js"><link rel="prefetch" href="/assets/js/4.46ad5bf7.js"><link rel="prefetch" href="/assets/js/6.9361dec1.js"><link rel="prefetch" href="/assets/js/7.3cafae79.js"><link rel="prefetch" href="/assets/js/8.a2fdc4e3.js"><link rel="prefetch" href="/assets/js/9.fe737b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">风痕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端基础课程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-basic-course/js-lang-history-and-basic.html" class="sidebar-link">JS语言历史及基本特性介绍</a></li><li><a href="/fe-basic-course/js-data-process/" class="sidebar-link">JS数据处理</a></li><li><a href="/fe-basic-course/ts-types-system.html" class="sidebar-link">系统化学习 TS 类型系统</a></li><li><a href="/fe-basic-course/js-concurrent.html" class="sidebar-link">JS 多线程并发</a></li><li><a href="/fe-basic-course/https-brief/https-brief.html" class="sidebar-link">HTTPS加密原理简介</a></li><li><a href="/fe-basic-course/options-request.html" class="sidebar-link">Options请求介绍及应对</a></li><li><a href="/fe-basic-course/timer-delay.html" class="sidebar-link">JS 定时器延迟时长细节</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端杂货</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/vuepress-gitment.html" class="sidebar-link">VuePress 集成第三方评论模块</a></li><li><a href="/fe/canvas-lib/" aria-current="page" class="active sidebar-link">Mini Canvas Lib 核心交互实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#零" class="sidebar-link">零</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#canvas绘制元素" class="sidebar-link">canvas绘制元素</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#移动元素" class="sidebar-link">移动元素</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#翻转元素" class="sidebar-link">翻转元素</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#旋转元素" class="sidebar-link">旋转元素</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#缩放元素" class="sidebar-link">缩放元素</a></li><li class="sidebar-sub-header"><a href="/fe/canvas-lib/#判断鼠标是否点击了元素" class="sidebar-link">判断鼠标是否点击了元素</a></li></ul></li><li><a href="/fe/body-mask-danmaku/" class="sidebar-link">Web 端基于机器学习实现防档（不挡脸）弹幕</a></li><li><a href="/fe/js-perf-detect.html" class="sidebar-link">JS 检测设备性能</a></li><li><a href="/fe/react-hooks/" class="sidebar-link">react hooks的思考</a></li><li><a href="/fe/thinking-miniprogram.html" class="sidebar-link">小程序的思考</a></li><li><a href="/fe/modularization/" class="sidebar-link">前端模块化设计</a></li><li><a href="/fe/vue-directive-track.html" class="sidebar-link">基于vue directive实现声明式埋点方案</a></li><li><a href="/fe/bug1-safari10.html" class="sidebar-link">BUG: Safari10 Cannot declare a let variable twice: 'e'.</a></li><li><a href="/fe/sw-ssr/" class="sidebar-link">同构项目 Service Worker 离线化实践</a></li><li><a href="/fe/run-web-project-in-termux.html" class="sidebar-link">在Termux中运行web项目</a></li><li><a href="/fe/debug-hover-element/" class="sidebar-link">调试鼠标悬浮（hover）元素的css技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/cljs-node-hotreload.html" class="sidebar-link">ClojureScript + node + hotreload</a></li><li><a href="/clojure/cljs-transient-performance.html" class="sidebar-link">cljs中普通与瞬态数据结构性能对比</a></li><li><a href="/clojure/shadow-cljs-proto-repl.html" class="sidebar-link">shadow-cljs项目 在 proto repl 切换namespace</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随想</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/think/dao.html" class="sidebar-link">天道</a></li><li><a href="/think/biosphere/" class="sidebar-link">生存空间</a></li><li><a href="/think/book-review.html" class="sidebar-link">书评笔记</a></li><li><a href="/think/qin/" class="sidebar-link">为何是秦灭六国，统一天下</a></li><li><a href="/think/interview.html" class="sidebar-link">技术面试中的“运气”指什么</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mini-canvas-lib-核心交互实现原理"><a href="#mini-canvas-lib-核心交互实现原理" class="header-anchor">#</a> Mini Canvas Lib 核心交互实现原理</h1> <p>背景：
需要使用 Canvas 实现添加图片、文字、摄像头画面，并且支持拖拽、缩放、旋转等功能。
但成熟 Canvas 库（比如 Sprite.js Fabric.js ）一般都比较庞大（300kb+），所以自己实现精简版本，减少体积。</p> <h2 id="零"><a href="#零" class="header-anchor">#</a> 零</h2> <p><strong>基本功能：</strong></p> <ul><li>拖拽移动元素</li> <li>缩放元素（变形、等比例缩放）</li> <li>旋转元素</li> <li>元素内容可以是：图片、文字、摄像头</li></ul> <p>画布中的元素（也可称为Sprite），每个元素的的位置信息由 IRect 描述，交互可体验<a href="http://fabricjs.com/" target="_blank" rel="noopener noreferrer">Fabric.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">IRect</span> <span class="token punctuation">{</span>
  x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  h<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Sprite</span> <span class="token punctuation">{</span>
  <span class="token comment">// 位置，尺寸数据</span>
  rect<span class="token operator">:</span> IRect
  <span class="token comment">// 旋转角度</span>
  angle<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/assets/img/canvas-sprite.542a3548.png" width="400px"> <h2 id="canvas绘制元素"><a href="#canvas绘制元素" class="header-anchor">#</a> canvas绘制元素</h2> <p>因为需绘制元素（图片、文字、视频）占用的位置都可用矩形表示，所以可以：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 将 canvas 坐标系原点移动到 rect 中心点</span>
ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 这样任意 rect 的绘制参数都是一样的</span>
ctx<span class="token punctuation">.</span><span class="token function">drwaImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token operator">-</span>w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span>h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token comment">// 围绕中心点旋转</span>
ctx<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
</code></pre></div><h2 id="移动元素"><a href="#移动元素" class="header-anchor">#</a> 移动元素</h2> <p>这一步非常简单，跟拖拽dom元素一样。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 1. 监听mousemove事件，由鼠标位置减去初始位置，可以得到移动的坐标差值。  </span>
<span class="token comment">// startX startY 是鼠标按下时的位置</span>
incX <span class="token operator">=</span> offsetX <span class="token operator">-</span> startX
incY <span class="token operator">=</span> offsetY <span class="token operator">-</span> startY
<span class="token comment">// 2. 将移动距离映射为 Canvas 坐标系中的距离（因为 Canvas clientWith 跟 width 很可能不一样）。  </span>
incX <span class="token operator">=</span> incX <span class="token operator">/</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>clientWith <span class="token operator">/</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token comment">// incY 同理</span>
<span class="token comment">// 3. 将新的坐标设置到元素的位置上。</span>
sprite<span class="token punctuation">.</span><span class="token function">setRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">+</span> incX<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">+</span> incY <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="翻转元素"><a href="#翻转元素" class="header-anchor">#</a> 翻转元素</h2> <p><em>一般通过右键菜单来触发翻转效果，接收到事件后选择以下某个方法</em></p> <p><strong>两个方法</strong></p> <ol><li>可通过 <code>ctx.setTransform</code> 实现。（<strong>建议</strong>，据说性能好些，不需要 ctx.save ctx.restore）</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/setTransform</span>
<span class="token comment">// 水平翻转</span>
ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 垂直翻转</span>
ctx<span class="token punctuation">.</span><span class="token function">setTransform</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>可通过 ctx.scale 实现。</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/scale</span>
<span class="token comment">// 水平翻转</span>
ctx<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 垂直翻转</span>
ctx<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="旋转元素"><a href="#旋转元素" class="header-anchor">#</a> 旋转元素</h2> <ol><li>获取旋转的中心点，通过 rect 计算得到。<code>{ x: x + w / 2, y: y + h / 2 }</code></li> <li>监听mousemove事件，获取鼠标坐标，由鼠标坐标得到旋转角度<code>angle = Math.atan2(y, x)</code>。</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">rotateSprite</span> <span class="token punctuation">(</span> <span class="token parameter">centerPos<span class="token punctuation">,</span> onChange</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> onMove <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> clientX<span class="token punctuation">,</span> clientY <span class="token punctuation">}</span><span class="token operator">:</span> MouseEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 映射为 相对中心点的坐标</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> clientX <span class="token operator">-</span> centerPos<span class="token punctuation">.</span>x
    <span class="token keyword">const</span> y <span class="token operator">=</span> clientY <span class="token operator">-</span> centerPos<span class="token punctuation">.</span>y
    <span class="token comment">// 旋转控制点在正上方，相对 x 轴是 -90°， 所以需要加上 Math.PI / 2</span>
    <span class="token keyword">const</span> angle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> clear <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> onMove<span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> clear<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> onMove<span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> clear<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="缩放元素"><a href="#缩放元素" class="header-anchor">#</a> 缩放元素</h2> <p><em>本身rect缩放非常简单，加上旋转后，缩放效果就复杂了很多。</em><br> <strong>比如：</strong></p> <ol><li>拖拽rect右侧的控制点，只能改变矩形的宽度，在旋转情况下，rect左侧的边是保持不动的。</li> <li>拖拽 rect 右下角的控制点，同时改变宽高，但需要位置等比，rect 左上角的点保持不动。</li></ol> <h3 id="所以这个题可以抽象为"><a href="#所以这个题可以抽象为" class="header-anchor">#</a> 所以这个题可以抽象为</h3> <ol><li>给出的参数：rect（坐标、宽高）数据，旋转角度、鼠标坐标。</li> <li>需要解出的答案：新的IRect（坐标、宽高）。</li></ol> <h3 id="解题步骤"><a href="#解题步骤" class="header-anchor">#</a> 解题步骤</h3> <p>以拖拽右下角控制点（RB）为例，因为是等比缩放，所以中心点会一直处于对角线（LT-RB）上。<br> <img src="/assets/img/scale-rect.3c089d1c.png" width="600px"></p> <ol><li>监听 mousemove 事件，获取鼠标坐标，减去中心点坐标，得到相对于中心点的坐标。</li> <li>根据坐标O、元素旋转角度、IRect，可计算出 RB 被 移动的长度。</li> <li>移动长度乘以对应的三角函数，即为增加的宽、高。</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 对角线角度（LB-RT对角线，角度是负数，需要乘以-1）</span>
<span class="token keyword">const</span> diagonalAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>h<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>w<span class="token punctuation">)</span>
<span class="token comment">// 坐标系旋转角度， lb-&gt;rt的对角线的初始角度为负数，所以需要乘以-1</span>
<span class="token keyword">const</span> rotateAngle <span class="token operator">=</span> diagonalAngle <span class="token operator">+</span> angle
<span class="token comment">// startPos 及 RB 的坐标（拖拽起始位置），ClientXY 是mousemove事件中获取的坐标</span>
<span class="token keyword">const</span> ox <span class="token operator">=</span> clientX <span class="token operator">-</span> startPos<span class="token punctuation">.</span>x
<span class="token keyword">const</span> oy <span class="token operator">=</span> clientY <span class="token operator">-</span> startPos<span class="token punctuation">.</span>y
<span class="token comment">// 坐标系旋转变化公式，让x轴与【对角线重合】，鼠标位置的x值即为增加的长度（RB’位于鼠标与对角线的垂直交点）</span>
<span class="token keyword">const</span> incS <span class="token operator">=</span> ox <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>rotateAngle<span class="token punctuation">)</span> <span class="token operator">+</span> oy <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>rotateAngle<span class="token punctuation">)</span>
<span class="token comment">// 等比例缩放，增加宽高等于长度乘以对应的角度函数</span>
<span class="token comment">// 因为等比例缩放，中心及被拖拽的点，一定在对角线上</span>
<span class="token keyword">const</span> incW <span class="token operator">=</span> incS <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>diagonalAngle<span class="token punctuation">)</span>
<span class="token keyword">const</span> incH <span class="token operator">=</span> incS <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>diagonalAngle<span class="token punctuation">)</span>

<span class="token comment">// 新中心点坐标, 原中心坐标 (x + w / 2, y + h / 2)</span>
<span class="token keyword">const</span> newCntX <span class="token operator">=</span> incS <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>rotateAngle<span class="token punctuation">)</span> <span class="token operator">+</span> x <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span>
<span class="token keyword">const</span> newCntY <span class="token operator">=</span> incS <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>rotateAngle<span class="token punctuation">)</span> <span class="token operator">+</span> y <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span>
<span class="token comment">// rect 新坐标</span>
<span class="token keyword">const</span> newX <span class="token operator">=</span> newCntX <span class="token operator">-</span> newW <span class="token operator">/</span> <span class="token number">2</span>
<span class="token keyword">const</span> newY <span class="token operator">=</span> newCntY <span class="token operator">-</span> newH <span class="token operator">/</span> <span class="token number">2</span>

<span class="token comment">// 新的rect: { x: newX, y: newY, w: newW, h: newH }</span>
</code></pre></div><p>上面代码用到了<strong>坐标系旋转变化公式</strong>，其推导如下图所示：
<img src="/assets/img/coord-rotation.f49dd5e5.png" width="600px"></p> <h3 id="其他缩放场景注意事项"><a href="#其他缩放场景注意事项" class="header-anchor">#</a> 其他缩放场景注意事项</h3> <ol><li>左边三个点的缩放，坐标值变小（负数），也是在放大，所以计算出来值要乘以-1。</li> <li>利用好坐标系旋转变化公式，拖拽某些点时，注意其角度与默认 X 轴之间的差值。</li></ol> <h2 id="判断鼠标是否点击了元素"><a href="#判断鼠标是否点击了元素" class="header-anchor">#</a> 判断鼠标是否点击了元素</h2> <ol><li>将鼠标坐标，rect xy 值转换为相对于中心点的坐标</li> <li>再求出鼠标坐标旋转 rect 角度后的坐标（坐标系旋转公式）</li> <li>判断鼠标点击的坐标是否超出 rect 边界</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// pos 鼠标坐标， rect center 中心点</span>
<span class="token comment">// 鼠标点击坐标映射成 canvas坐标, 然后转换为以中点为原点的坐标</span>
<span class="token keyword">const</span> cvsOX <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">/</span> ratio<span class="token punctuation">.</span>w <span class="token operator">-</span> center<span class="token punctuation">.</span>x
<span class="token keyword">const</span> cvsOY <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">/</span> ratio<span class="token punctuation">.</span>h <span class="token operator">-</span> center<span class="token punctuation">.</span>y

<span class="token comment">// 如果有旋转，映射成相对原点，旋转前的坐标</span>
<span class="token keyword">let</span> mx <span class="token operator">=</span> cvsOX
<span class="token keyword">let</span> my <span class="token operator">=</span> cvsOY

<span class="token keyword">let</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token punctuation">}</span> <span class="token operator">=</span> rect
<span class="token comment">// 映射成中心点坐标</span>
x <span class="token operator">=</span> x <span class="token operator">-</span> center<span class="token punctuation">.</span>x
y <span class="token operator">=</span> y <span class="token operator">-</span> center<span class="token punctuation">.</span>y
<span class="token comment">// 坐标系旋转变化公式 </span>
mx <span class="token operator">=</span> cvsOX <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">+</span> cvsOY <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
my <span class="token operator">=</span> cvsOY <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token operator">-</span> cvsOX <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>mx <span class="token operator">&lt;</span> x <span class="token operator">||</span> mx <span class="token operator">&gt;</span> x <span class="token operator">+</span> w <span class="token operator">||</span> my <span class="token operator">&lt;</span> y <span class="token operator">||</span> my <span class="token operator">&gt;</span> y <span class="token operator">+</span> h<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

<span class="token keyword">return</span> <span class="token boolean">true</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe/vuepress-gitment.html" class="prev">
        VuePress 集成第三方评论模块
      </a></span> <span class="next"><a href="/fe/body-mask-danmaku/">
        Web 端基于机器学习实现防档（不挡脸）弹幕
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdd650a.js" defer></script><script src="/assets/js/2.f69a5113.js" defer></script><script src="/assets/js/5.279f05c1.js" defer></script>
  </body>
</html>
