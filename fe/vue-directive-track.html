<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于vue directive实现声明式埋点方案 | 风痕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="...">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.5bdd650a.js" as="script"><link rel="preload" href="/assets/js/2.f69a5113.js" as="script"><link rel="preload" href="/assets/js/12.18e1a8d3.js" as="script"><link rel="prefetch" href="/assets/js/10.5c2bb7c0.js"><link rel="prefetch" href="/assets/js/11.a9e937f3.js"><link rel="prefetch" href="/assets/js/13.086c173f.js"><link rel="prefetch" href="/assets/js/14.ba45a4c1.js"><link rel="prefetch" href="/assets/js/15.3332d864.js"><link rel="prefetch" href="/assets/js/16.a62b9621.js"><link rel="prefetch" href="/assets/js/17.df315171.js"><link rel="prefetch" href="/assets/js/18.2a0aea87.js"><link rel="prefetch" href="/assets/js/19.723e65fd.js"><link rel="prefetch" href="/assets/js/20.530ad6f9.js"><link rel="prefetch" href="/assets/js/21.3d3402c7.js"><link rel="prefetch" href="/assets/js/22.d9c40d56.js"><link rel="prefetch" href="/assets/js/23.f4ca2db8.js"><link rel="prefetch" href="/assets/js/24.42966d79.js"><link rel="prefetch" href="/assets/js/25.acb12a54.js"><link rel="prefetch" href="/assets/js/26.e42497f5.js"><link rel="prefetch" href="/assets/js/27.2a48814c.js"><link rel="prefetch" href="/assets/js/28.b9a1fa55.js"><link rel="prefetch" href="/assets/js/29.fc3b3ec7.js"><link rel="prefetch" href="/assets/js/3.b1eb6805.js"><link rel="prefetch" href="/assets/js/30.8aa1373a.js"><link rel="prefetch" href="/assets/js/31.064b6ef6.js"><link rel="prefetch" href="/assets/js/32.2d7f9391.js"><link rel="prefetch" href="/assets/js/33.da7b40ae.js"><link rel="prefetch" href="/assets/js/34.48af420a.js"><link rel="prefetch" href="/assets/js/35.b5212b6b.js"><link rel="prefetch" href="/assets/js/36.6e4b1ce2.js"><link rel="prefetch" href="/assets/js/37.7815b84c.js"><link rel="prefetch" href="/assets/js/38.22e0cdb1.js"><link rel="prefetch" href="/assets/js/39.467f0eff.js"><link rel="prefetch" href="/assets/js/4.46ad5bf7.js"><link rel="prefetch" href="/assets/js/5.279f05c1.js"><link rel="prefetch" href="/assets/js/6.9361dec1.js"><link rel="prefetch" href="/assets/js/7.3cafae79.js"><link rel="prefetch" href="/assets/js/8.a2fdc4e3.js"><link rel="prefetch" href="/assets/js/9.fe737b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">风痕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端基础课程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-basic-course/js-lang-history-and-basic.html" class="sidebar-link">JS语言历史及基本特性介绍</a></li><li><a href="/fe-basic-course/js-data-process/" class="sidebar-link">JS数据处理</a></li><li><a href="/fe-basic-course/ts-types-system.html" class="sidebar-link">系统化学习 TS 类型系统</a></li><li><a href="/fe-basic-course/js-concurrent.html" class="sidebar-link">JS 多线程并发</a></li><li><a href="/fe-basic-course/https-brief/https-brief.html" class="sidebar-link">HTTPS加密原理简介</a></li><li><a href="/fe-basic-course/options-request.html" class="sidebar-link">Options请求介绍及应对</a></li><li><a href="/fe-basic-course/timer-delay.html" class="sidebar-link">JS 定时器延迟时长细节</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端杂货</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/vuepress-gitment.html" class="sidebar-link">VuePress 集成第三方评论模块</a></li><li><a href="/fe/canvas-lib/" class="sidebar-link">Mini Canvas Lib 核心交互实现原理</a></li><li><a href="/fe/body-mask-danmaku/" class="sidebar-link">Web 端基于机器学习实现防档（不挡脸）弹幕</a></li><li><a href="/fe/js-perf-detect.html" class="sidebar-link">JS 检测设备性能</a></li><li><a href="/fe/react-hooks/" class="sidebar-link">react hooks的思考</a></li><li><a href="/fe/thinking-miniprogram.html" class="sidebar-link">小程序的思考</a></li><li><a href="/fe/modularization/" class="sidebar-link">前端模块化设计</a></li><li><a href="/fe/vue-directive-track.html" aria-current="page" class="active sidebar-link">基于vue directive实现声明式埋点方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#传统埋点-vs-声明式埋点" class="sidebar-link">传统埋点 vs 声明式埋点</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#调研" class="sidebar-link">调研</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#收益" class="sidebar-link">收益</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#详细api" class="sidebar-link">详细API</a></li><li class="sidebar-sub-header"><a href="/fe/vue-directive-track.html#可参考的指令源码" class="sidebar-link">可参考的指令源码</a></li></ul></li><li><a href="/fe/bug1-safari10.html" class="sidebar-link">BUG: Safari10 Cannot declare a let variable twice: 'e'.</a></li><li><a href="/fe/sw-ssr/" class="sidebar-link">同构项目 Service Worker 离线化实践</a></li><li><a href="/fe/run-web-project-in-termux.html" class="sidebar-link">在Termux中运行web项目</a></li><li><a href="/fe/debug-hover-element/" class="sidebar-link">调试鼠标悬浮（hover）元素的css技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/cljs-node-hotreload.html" class="sidebar-link">ClojureScript + node + hotreload</a></li><li><a href="/clojure/cljs-transient-performance.html" class="sidebar-link">cljs中普通与瞬态数据结构性能对比</a></li><li><a href="/clojure/shadow-cljs-proto-repl.html" class="sidebar-link">shadow-cljs项目 在 proto repl 切换namespace</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随想</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/think/dao.html" class="sidebar-link">天道</a></li><li><a href="/think/biosphere/" class="sidebar-link">生存空间</a></li><li><a href="/think/book-review.html" class="sidebar-link">书评笔记</a></li><li><a href="/think/qin/" class="sidebar-link">为何是秦灭六国，统一天下</a></li><li><a href="/think/interview.html" class="sidebar-link">技术面试中的“运气”指什么</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基于vue-directive实现声明式埋点方案"><a href="#基于vue-directive实现声明式埋点方案" class="header-anchor">#</a> 基于vue directive实现声明式埋点方案</h1> <p><strong>注：本方案依赖<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener noreferrer">vue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/aFarkas/lazysizes" target="_blank" rel="noopener noreferrer">lazysizes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(曝光事件：lazybeforeunveil)</strong></p> <h2 id="传统埋点-vs-声明式埋点"><a href="#传统埋点-vs-声明式埋点" class="header-anchor">#</a> 传统埋点 vs 声明式埋点</h2> <p><strong>正文开始前，对比展示一下效果，方便读者判断是否有兴趣 :）</strong></p> <p><strong>传统埋点</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>handleMoreClick(0)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>More<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">handleMoreClick</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onAnalyticsEvent</span><span class="token punctuation">(</span><span class="token string">'查看更多'</span><span class="token punctuation">,</span> <span class="token string">'签到活动card【查看更多】_click'</span><span class="token punctuation">,</span> <span class="token string">'b_4ezhmbjt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onAnalyticsEvent</span><span class="token punctuation">(</span><span class="token parameter">element_id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> bid<span class="token punctuation">,</span> lab</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      AnalyticsUtil<span class="token punctuation">.</span><span class="token function">sendAnalyticsEvent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        val<span class="token operator">:</span> <span class="token punctuation">{</span>
          element_id<span class="token punctuation">,</span>
          title<span class="token punctuation">,</span>
          bid<span class="token punctuation">,</span>
          lab<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>声明式埋点</strong></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-mge:</span>b_4ezhmbjt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>More<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">/* 无需写其他代码 */</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><em>神奇的<code>v-mge</code>如何实现，埋点信息如何获取？ 请看下文分解~</em></p> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <ol><li>前端页面埋点需求很多，基本采用传统的命令式埋点，随着项目业务需求开发持续进行，出现越来越多的冗余代码，虽做了部分公共封装，但与业务逻辑无关的埋点代码还是不可逆地累积，且分散在源码各处。</li> <li>埋点过程有较多重复性劳动，低效率且容易出错。<br>
团队埋点流程：产品配置埋点-&gt;开发从平台逐个copy埋点信息-&gt;粘贴到源码-&gt;运行时发送埋点。</li></ol> <h2 id="调研"><a href="#调研" class="header-anchor">#</a> 调研</h2> <ol><li><p>接收到优化埋点的任务时开始调研，准备了两套方案：a: 可视化无痕埋点；b: 声明式埋点。</p></li> <li><p>方案一最终流产。不过多介绍，原因总结如下：</p> <ul><li>重新制定了埋点流程，需多方配合</li> <li>开发工作量大且复杂<br> <em>虽可提供动态埋点功能，但产品对现有埋点流程无痛感，无动力使用新方案。<br>
所以，为解决自己的问题，期望别人做太大改动是不切实际的。</em></li></ul></li> <li><p>声明式埋点依赖<code>vue</code>框架，可以提升效率，仍需要维护埋点信息（按页面统一维护），但实现起来足够简单，且对流程无影响。</p></li></ol> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p><strong>资源依赖如图：</strong></p> <ol><li>通过Chrome插件（推荐chrome插件，可快速写写浏览器<a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank" rel="noopener noreferrer">tampermonkey<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）生成mge data（这部分是团队定制的，不作介绍）。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成的数据样例</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">b_4ezhmbjt</span><span class="token operator">:</span> <span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    elementName<span class="token operator">:</span> <span class="token string">'查看更多'</span><span class="token punctuation">,</span>
    eventName<span class="token operator">:</span> <span class="token string">'签到活动card【查看更多】_click'</span><span class="token punctuation">,</span>
    eventType<span class="token operator">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
    custom<span class="token operator">:</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>在页面（page.vue）导入埋点数据、注册指令。</li> <li>在根节点订阅（mgeSubscriber）指令发布的消息，所有埋点事件触发后都将埋点数据传递给该订阅者。<br> <img src="/assets/img/mge1.483c0efe.png" alt=""></li></ol> <p><strong>数据流向：</strong></p> <ol><li>指令（v-mge）初始化时给dom节点绑定事件。</li> <li>事件触发时根据埋点id获取对应的埋点信息，加上业务参数合成完整的埋点数据。</li> <li>完整的埋点数据传递给Vue实例根节点提供（Provide）的<code>mgeSubscriber</code>。</li> <li><code>mgeSubscriber</code>接收到数据后上报到埋点服务器。
<img src="/assets/img/mge2.edd4e37e.png" alt=""></li></ol> <h2 id="收益"><a href="#收益" class="header-anchor">#</a> 收益</h2> <ul><li>一个埋点大约能节约1~2分钟</li> <li>一个埋点大约5行代码，精简到可以忽略</li> <li>埋点数据从业务代码中剥离出来（单独文件管理，import到页面）</li> <li>覆盖90%以上的场景（UI组件内事件需要在handler中上报，不能通过指令埋点）</li></ul> <h2 id="详细api"><a href="#详细api" class="header-anchor">#</a> 详细API</h2> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 携带一个业务字段事件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-dr-mge:</span>b_5ix7ve3c</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{ a }}
    <span class="token comment">&lt;!-- 携带多个业务字段 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-dr-mge:</span>b_7sslet2v</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[title, shopId]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      {{ b }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 不携带业务参数事件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-dr-mge:</span>b_vyc33sw0</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(v, index) in arr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 曝光+click事件 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">v-dr-mge:</span>b_1rlrj8dr|b_6zn0e86f</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[v, index]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{v}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="可参考的指令源码"><a href="#可参考的指令源码" class="header-anchor">#</a> 可参考的指令源码</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'lazysizes'</span><span class="token punctuation">;</span>

<span class="token comment">// 每个埋点传递进来的值，经过MGE_DATA转换后的结果，当事件触发时将结果发送给provide</span>
<span class="token keyword">const</span> <span class="token constant">CACHE_DATA</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handleMge</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> bidKey<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// click使用el，曝光使用e.target</span>
  <span class="token keyword">const</span> uniqBid <span class="token operator">=</span> <span class="token punctuation">(</span>el <span class="token operator">||</span> e<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>bidKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mgeInfo <span class="token operator">=</span> <span class="token constant">CACHE_DATA</span><span class="token punctuation">[</span>uniqBid<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mgeInfo<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> subscriber <span class="token punctuation">}</span> <span class="token operator">=</span> mgeInfo<span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>bid <span class="token operator">=</span> uniqBid<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/-\d+$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">subscriber</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 绑定lazysizes提供的lazybeforeunveil事件</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'lazybeforeunveil'</span><span class="token punctuation">,</span> <span class="token function">handleMge</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'viewMgeBid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 判断传递给指令的新值、旧值是否相等</span>
<span class="token keyword">function</span> <span class="token function">directiveValueEquals</span><span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>v1 <span class="token operator">===</span> v2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v1 <span class="token operator">!==</span> <span class="token keyword">typeof</span> v2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> v2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 生成唯一值，解决一个bid被注册多次的场景。如在v-for生成的元素上使用dr-mge</span>
<span class="token keyword">const</span> uniq <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token parameter">bid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    id <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 创建mge指令
 * @param  {object} mgeData 从ocean获取的埋点数据
 * @return {object}         vue 指令
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createMgeDirective</span><span class="token punctuation">(</span><span class="token parameter">mgeData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mgeData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> mgeData <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// eslint-disable-next-line</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">inserted</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> arg<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> binding<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> $mgeSubscriber <span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$root<span class="token punctuation">.</span>_provided<span class="token punctuation">;</span>
      <span class="token comment">// 如果根节点未提供处理mge事件的handle，则忽略该指令</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$mgeSubscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'root节点provide没有$mgeSubscriber'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">bid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mgeInfo <span class="token operator">=</span> mgeData<span class="token punctuation">[</span>bid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mgeInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'未注册埋点信息的bid：'</span><span class="token punctuation">,</span> bid<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> uniqBid <span class="token operator">=</span> <span class="token function">uniq</span><span class="token punctuation">(</span>bid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> eventData <span class="token operator">=</span> <span class="token keyword">typeof</span> mgeInfo <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">mgeInfo</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> mgeInfo<span class="token punctuation">;</span>

        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventData<span class="token punctuation">.</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-mge-bid</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> uniqBid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">CACHE_DATA</span><span class="token punctuation">[</span>uniqBid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          data<span class="token operator">:</span> eventData<span class="token punctuation">,</span>
          subscriber<span class="token operator">:</span> $mgeSubscriber<span class="token punctuation">,</span> <span class="token comment">// 当mge事件触发时将data传递给handle</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventData<span class="token punctuation">.</span>eventType <span class="token operator">===</span> <span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token function">handleMge</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> <span class="token string">'clickMgeBid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          eventData<span class="token punctuation">.</span>eventType <span class="token operator">===</span> <span class="token string">'view'</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'lazyload'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          el<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'lazyload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">componentUpdated</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> arg<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue <span class="token punctuation">}</span> <span class="token operator">=</span> binding<span class="token punctuation">;</span>

      arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">bid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从dataset中查找 uniqBid</span>
        <span class="token keyword">const</span> uniqBid <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-\\d+$</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uniqBid<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> mgeInfo <span class="token operator">=</span> mgeData<span class="token punctuation">[</span>bid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> cacheData <span class="token operator">=</span> <span class="token constant">CACHE_DATA</span><span class="token punctuation">[</span>uniqBid<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mgeInfo <span class="token operator">&amp;&amp;</span> cacheData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 更新缓存值</span>
          cacheData<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">typeof</span> mgeInfo <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">mgeInfo</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> mgeInfo<span class="token punctuation">;</span>

          <span class="token comment">// 曝光事件，当传递的参数改变时需要重新曝光，重置class</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>eventType <span class="token operator">===</span> <span class="token string">'view'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">directiveValueEquals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            el<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'lazyloaded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            el<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'lazyload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'指令更新异常，未找到该埋点信息或缓存数据'</span><span class="token punctuation">,</span> bid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">unbind</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      binding<span class="token punctuation">.</span>arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">bid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token constant">CACHE_DATA</span><span class="token punctuation">[</span>bid<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe/modularization/" class="prev">
        前端模块化设计
      </a></span> <span class="next"><a href="/fe/bug1-safari10.html">
        BUG: Safari10 Cannot declare a let variable twice: 'e'.
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdd650a.js" defer></script><script src="/assets/js/2.f69a5113.js" defer></script><script src="/assets/js/12.18e1a8d3.js" defer></script>
  </body>
</html>
