<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>同构项目 Service Worker 离线化实践 | 风痕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="...">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.5bdd650a.js" as="script"><link rel="preload" href="/assets/js/2.f69a5113.js" as="script"><link rel="preload" href="/assets/js/11.a9e937f3.js" as="script"><link rel="prefetch" href="/assets/js/10.5c2bb7c0.js"><link rel="prefetch" href="/assets/js/12.18e1a8d3.js"><link rel="prefetch" href="/assets/js/13.086c173f.js"><link rel="prefetch" href="/assets/js/14.ba45a4c1.js"><link rel="prefetch" href="/assets/js/15.3332d864.js"><link rel="prefetch" href="/assets/js/16.a62b9621.js"><link rel="prefetch" href="/assets/js/17.df315171.js"><link rel="prefetch" href="/assets/js/18.2a0aea87.js"><link rel="prefetch" href="/assets/js/19.723e65fd.js"><link rel="prefetch" href="/assets/js/20.530ad6f9.js"><link rel="prefetch" href="/assets/js/21.3d3402c7.js"><link rel="prefetch" href="/assets/js/22.d9c40d56.js"><link rel="prefetch" href="/assets/js/23.f4ca2db8.js"><link rel="prefetch" href="/assets/js/24.42966d79.js"><link rel="prefetch" href="/assets/js/25.acb12a54.js"><link rel="prefetch" href="/assets/js/26.e42497f5.js"><link rel="prefetch" href="/assets/js/27.2a48814c.js"><link rel="prefetch" href="/assets/js/28.b9a1fa55.js"><link rel="prefetch" href="/assets/js/29.fc3b3ec7.js"><link rel="prefetch" href="/assets/js/3.b1eb6805.js"><link rel="prefetch" href="/assets/js/30.8aa1373a.js"><link rel="prefetch" href="/assets/js/31.064b6ef6.js"><link rel="prefetch" href="/assets/js/32.2d7f9391.js"><link rel="prefetch" href="/assets/js/33.da7b40ae.js"><link rel="prefetch" href="/assets/js/34.48af420a.js"><link rel="prefetch" href="/assets/js/35.b5212b6b.js"><link rel="prefetch" href="/assets/js/36.6e4b1ce2.js"><link rel="prefetch" href="/assets/js/37.7815b84c.js"><link rel="prefetch" href="/assets/js/38.22e0cdb1.js"><link rel="prefetch" href="/assets/js/39.467f0eff.js"><link rel="prefetch" href="/assets/js/4.46ad5bf7.js"><link rel="prefetch" href="/assets/js/5.279f05c1.js"><link rel="prefetch" href="/assets/js/6.9361dec1.js"><link rel="prefetch" href="/assets/js/7.3cafae79.js"><link rel="prefetch" href="/assets/js/8.a2fdc4e3.js"><link rel="prefetch" href="/assets/js/9.fe737b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">风痕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端基础课程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-basic-course/js-lang-history-and-basic.html" class="sidebar-link">JS语言历史及基本特性介绍</a></li><li><a href="/fe-basic-course/js-data-process/" class="sidebar-link">JS数据处理</a></li><li><a href="/fe-basic-course/ts-types-system.html" class="sidebar-link">系统化学习 TS 类型系统</a></li><li><a href="/fe-basic-course/js-concurrent.html" class="sidebar-link">JS 多线程并发</a></li><li><a href="/fe-basic-course/https-brief/https-brief.html" class="sidebar-link">HTTPS加密原理简介</a></li><li><a href="/fe-basic-course/options-request.html" class="sidebar-link">Options请求介绍及应对</a></li><li><a href="/fe-basic-course/timer-delay.html" class="sidebar-link">JS 定时器延迟时长细节</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端杂货</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/vuepress-gitment.html" class="sidebar-link">VuePress 集成第三方评论模块</a></li><li><a href="/fe/canvas-lib/" class="sidebar-link">Mini Canvas Lib 核心交互实现原理</a></li><li><a href="/fe/body-mask-danmaku/" class="sidebar-link">Web 端基于机器学习实现防档（不挡脸）弹幕</a></li><li><a href="/fe/js-perf-detect.html" class="sidebar-link">JS 检测设备性能</a></li><li><a href="/fe/react-hooks/" class="sidebar-link">react hooks的思考</a></li><li><a href="/fe/thinking-miniprogram.html" class="sidebar-link">小程序的思考</a></li><li><a href="/fe/modularization/" class="sidebar-link">前端模块化设计</a></li><li><a href="/fe/vue-directive-track.html" class="sidebar-link">基于vue directive实现声明式埋点方案</a></li><li><a href="/fe/bug1-safari10.html" class="sidebar-link">BUG: Safari10 Cannot declare a let variable twice: 'e'.</a></li><li><a href="/fe/sw-ssr/" aria-current="page" class="active sidebar-link">同构项目 Service Worker 离线化实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/sw-ssr/#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/fe/sw-ssr/#方案" class="sidebar-link">方案</a></li><li class="sidebar-sub-header"><a href="/fe/sw-ssr/#意外问题" class="sidebar-link">意外问题</a></li></ul></li><li><a href="/fe/run-web-project-in-termux.html" class="sidebar-link">在Termux中运行web项目</a></li><li><a href="/fe/debug-hover-element/" class="sidebar-link">调试鼠标悬浮（hover）元素的css技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/cljs-node-hotreload.html" class="sidebar-link">ClojureScript + node + hotreload</a></li><li><a href="/clojure/cljs-transient-performance.html" class="sidebar-link">cljs中普通与瞬态数据结构性能对比</a></li><li><a href="/clojure/shadow-cljs-proto-repl.html" class="sidebar-link">shadow-cljs项目 在 proto repl 切换namespace</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随想</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/think/dao.html" class="sidebar-link">天道</a></li><li><a href="/think/biosphere/" class="sidebar-link">生存空间</a></li><li><a href="/think/book-review.html" class="sidebar-link">书评笔记</a></li><li><a href="/think/qin/" class="sidebar-link">为何是秦灭六国，统一天下</a></li><li><a href="/think/interview.html" class="sidebar-link">技术面试中的“运气”指什么</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="同构项目-service-worker-离线化实践"><a href="#同构项目-service-worker-离线化实践" class="header-anchor">#</a> 同构项目 Service Worker 离线化实践</h1> <blockquote><p><em>阅读本文需要相关知识储备</em>：  <a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle?hl=zh-cn" target="_blank" rel="noopener noreferrer">Service Worker 生命周期<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/GoogleChrome/workbox" target="_blank" rel="noopener noreferrer">Workbox<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、前端同构渲染</p></blockquote> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>团队计划在产品中尝试离线化某些功能，在这之前项目已经简单引入了<a href="https://github.com/GoogleChrome/workbox" target="_blank" rel="noopener noreferrer">workbox<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来管理静态资源。因为没有缓存动态接口数据，所有页面并不支持离线访问。<br>
目标：使高流量页面支持离线访问，让用户意识到网页（非APP）也能在无网络场景下使用。</p> <h2 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h2> <h3 id="调研"><a href="#调研" class="header-anchor">#</a> 调研</h3> <p>在对SW工作原理有初步了解之后，分析总结我们面临的主要问题分两类。</p> <ul><li>如何管理缓存资源（静态资源、接口数据）
<ul><li>如何缓存静态资源（js, css...）</li> <li>如何缓存后台接口数据</li> <li>如何缓存动态获取的资源（如从接口获取的页面头图）</li> <li>如何清除失效缓存</li></ul></li> <li>如何解决同构项目特有问题（问题较复杂，后文详细描述）</li></ul> <p>用一张图来描述大致的方案<br> <img src="/assets/img/ssr-design.0db6d6b7.png" alt=""></p> <h3 id="缓存管理"><a href="#缓存管理" class="header-anchor">#</a> 缓存管理</h3> <p>针对缓存管理的问题，决定以workbox为基础来实现。<br>
使用的workbox提供的 <a href="https://developers.google.com/web/tools/workbox/guides/generate-service-worker/webpack" target="_blank" rel="noopener noreferrer">workbox-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://developers.google.com/web/tools/workbox/guides/precache-files/" target="_blank" rel="noopener noreferrer">Precache Files<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://developers.google.com/web/tools/workbox/guides/route-requests" target="_blank" rel="noopener noreferrer">Route Requests<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 功能，然后再在其上编写动态资源、缓存清除逻辑，缓存关的问题基本上都解决了。<br>
大致步骤如下：</p> <ol><li>集成workbox-webpack-plugin插件到构建流程，<code>workboxPlugin.GenerateSW</code>生成precache-manifest文件(包含所有静态资源的路径)</li> <li>避免占用太多空间、节省流量等原因，只预缓存项目公共资源 <code>workbox.precaching.precacheAndRoute(self.__precacheManifest.filter(/* 自定义规则 */))</code>，SW每次install会增量获取有更新的资源</li> <li><code>workbox.routing.registerRoute</code>拦截并缓存需离线访问页面的动态请求
<ul><li>如何缓存通过接口获取的头图url？<code>registerRoute</code>注册一个特殊路由，获取到头图url之后发送给SW，SW发起图片请求缓存Response。<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// service worker js</span>
workbox<span class="token punctuation">.</span>routing<span class="token punctuation">.</span><span class="token function">registerRoute</span><span class="token punctuation">(</span><span class="token regex">/sw-api\/cache-static-res/</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">await</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=&gt;</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    statusText<span class="token operator">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">)</span>
<span class="token comment">// page js</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/sw-api/cache-static-res'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  body<span class="token operator">:</span> <span class="token string">'http://xxxxxxxx.png'</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li>非公共资源，按页面缓存到Cache Storage对应的key（根据页面生成）下，当页面达到一定数量则清除最老的页面缓存
<ul><li>如何获取到最旧的页面缓存？可以在每个页面对应的key下创建一个时间戳缓存项，页面每次访问时都更新时间戳 <code>cache.put('update-timestamp', new Response(Date.now())</code></li></ul></li></ol> <h3 id="同构项目特有问题"><a href="#同构项目特有问题" class="header-anchor">#</a> 同构项目特有问题</h3> <p><strong>背景：不同渲染模式的差异</strong></p> <ul><li>纯Server端渲染，每访问一个页面，Server请求<strong>页面初始化接口(init request)</strong>，渲染完成后直接返回一个完整的已初始化的html文档。</li> <li>Client端渲染，当访问一个页面时，通常是由静态资源服务器（如Nginx、Apache）或CDN返回一个非常简单的<strong>骨架html</strong>文档，然后加载页面的依赖的“<strong>*.bundle.js</strong>”文件，由js请求**页面初始化接口(init request)**再生成dom挂载到html中的一个空节点上。</li> <li>同构渲染则结合两者的优点，用户在浏览器中第一次打开页面，由Server渲染（更快地展现第一屏、有利于SEO），之后的用户在站内跳转则使用客户端渲染（节省流量、减少服务端压力）。</li></ul> <p>假设用户先打开 页面A，再跳转到 页面B（A -&gt; B）。<br>
从背景描述我们可以知道对于A（html）、B（B.bundle.js + init request）两个页面，SW能截获到的内容是不一样的。<br>
如果在离线场景下，用户是打开 页面B，再跳转 页面A。如何生成页面B的html，获取页面A的init request呢？<br>
同构项目的特殊问题即：<strong>在离线场景下，如何保证任意页面能够以任意路径访问。</strong></p> <p>离线场景不能访问网络，所以必须完全启用Client渲染。（也可以在用户访问页面时，额外发送一个请求，然后缓存由Server返回的html，但这种方式比较浪费资源）<br> <strong>为了使页面在不能访问网络的情况下正确渲染，需要解决两个问题：</strong></p> <ol><li>构建骨架html，其中引入必要的js、css。离线打开页面时返回骨架html，作为入口启动Client渲染。</li> <li>Server端渲染请求的init request想办法传递到Client，由SW缓存起来。</li></ol> <h4 id="构建骨架html"><a href="#构建骨架html" class="header-anchor">#</a> 构建骨架html</h4> <ol><li>创建一个shell.html，留下两个标记用来注入页面依赖的js、css url<div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject main-css --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject scripts --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li>在SW <code>install</code> 事件中请求shell.html，注入页面依赖的js、css，然后缓存到caches中<div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> installHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">installHandler</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用webpack打包，页面依赖的三个公共js</span>
  <span class="token keyword">const</span> regx <span class="token operator">=</span> <span class="token regex">/(?:runtime~main|main|vendors~main)(?:\.\w+)?\.js/</span><span class="token punctuation">;</span>

  <span class="token comment">// __precacheManifest是workbox生成的SW全局变量</span>
  <span class="token keyword">const</span> startJS <span class="token operator">=</span> self<span class="token punctuation">.</span>__precacheManifest
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> url<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">url</span> <span class="token operator">=&gt;</span> regx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script src=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> mainCSSUrl <span class="token operator">=</span> self<span class="token punctuation">.</span>__precacheManifest
    <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token regex">/main\.\w+\.css$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mainCSS <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> mainCSSUrl <span class="token operator">?</span> mainCSSUrl<span class="token punctuation">.</span>url <span class="token operator">:</span> <span class="token string">''</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pre-cache-tpl</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pre-cache-tpl</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/app-shell.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> txt <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
        <span class="token string">'/app-shell.html'</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>
          txt
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- inject scripts --&gt;'</span><span class="token punctuation">,</span> startJS<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- inject main-css --&gt;'</span><span class="token punctuation">,</span> mainCSS<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            headers<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html;charset=UTF-8'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>当一个导航请求失败时，从caches中读取shell.html返回，页面渲染完成后将dom挂载到<code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code>节点上。<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* request error &amp;&amp; */</span> req<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token string">'navigate'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'/app-shell.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="缓存init-request"><a href="#缓存init-request" class="header-anchor">#</a> 缓存init request</h4> <ol><li>拦截所有Server发送的页面必要的请求。（主流的api库都提供interceptor功能）<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">INIT_REQUESTS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// data是接口返回的数据</span>
<span class="token constant">INIT_REQUESTS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  path<span class="token punctuation">,</span>
  resp<span class="token operator">:</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> statusText<span class="token punctuation">,</span> data<span class="token punctuation">,</span> headers <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li>将请求结果序列化后放到返回的主文档中。<div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
window<span class="token punctuation">.</span><span class="token constant">INIT_REQUESTS</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">INIT_REQUESTS</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li>Client反序列化后，发送给SW，SW重建Response缓存到cacehs中。<div class="language-js extra-class"><pre class="language-js"><code>cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> status<span class="token punctuation">,</span> statusText <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p><em>以上是示例代码，同构项目通常会使用状态管理工具（如Vuex）把数据从Server同步到Client，免去了手动序列化的过程，只需要在rootState中用一个key来存储接口数据</em></p> <h2 id="意外问题"><a href="#意外问题" class="header-anchor">#</a> 意外问题</h2> <p><em>以下记录一些大家可能会碰到的问题</em></p> <h3 id="sw文件热更新几率性失效"><a href="#sw文件热更新几率性失效" class="header-anchor">#</a> SW文件热更新几率性失效</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src要传全路径，传相对路径不会报错，但可能会导致热更新失效。跟webpack的缓存文件缓存有关系</span>
workboxPlugin<span class="token punctuation">.</span><span class="token function">InjectManifest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  swSrc<span class="token operator">:</span> swConfig<span class="token punctuation">.</span>src<span class="token punctuation">,</span>  
  swDest<span class="token operator">:</span> <span class="token string">'service-worker.js'</span><span class="token punctuation">,</span>
  importWorkboxFrom<span class="token operator">:</span> <span class="token string">'local'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="不要拦截页面的所有fetch请求"><a href="#不要拦截页面的所有fetch请求" class="header-anchor">#</a> 不要拦截页面的所有Fetch请求</h3> <p>只关注需要缓存请求，避免出现意外情况。例如开发阶段用来热更新的接口（<code>sockjs-node/932/vpeauunq/websocket</code>）被拦截后，如果勾选了<code>Update on reload</code>刷新时会导致页面处于卡死状态。<br> <img src="/assets/img/ssr-update-on-reload.475f14f3.png" alt=""></p> <h3 id="无网或弱网环境及时中断请求"><a href="#无网或弱网环境及时中断请求" class="header-anchor">#</a> 无网或弱网环境及时中断请求</h3> <p>真机环境浏览器需要尝试很长的时间才会告诉你请求失败（连上wifi并不代表wifi可用，浏览器也不知道到底能不能正常访问网络），如果你的网页支持离线访问，建议设置超时时间提前中断请求，否则用户很可能还没看到你的离线页面就退出了。</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fetch </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url <span class="token operator">||</span> req<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> timeout</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">FETCH_TIMEOUT</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="preview面板可能展示与实际不符的内容"><a href="#preview面板可能展示与实际不符的内容" class="header-anchor">#</a> preview面板可能展示与实际不符的内容</h3> <p>如果你将时间戳写入caches，在devtools Cache Storge 的 preview面板将展示错误的值，程序将读取到正确的值。<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=917826&amp;can=1&amp;q=hughfenghen&amp;colspec=ID%20Pri%20M%20Stars%20ReleaseBlock%20Component%20Status%20Owner%20Summary%20OS%20Modified" target="_blank" rel="noopener noreferrer">bug地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe/bug1-safari10.html" class="prev">
        BUG: Safari10 Cannot declare a let variable twice: 'e'.
      </a></span> <span class="next"><a href="/fe/run-web-project-in-termux.html">
        在Termux中运行web项目
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdd650a.js" defer></script><script src="/assets/js/2.f69a5113.js" defer></script><script src="/assets/js/11.a9e937f3.js" defer></script>
  </body>
</html>
