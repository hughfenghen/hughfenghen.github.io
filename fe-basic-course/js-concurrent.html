<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JS 多线程并发 | 风痕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="...">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.5bdd650a.js" as="script"><link rel="preload" href="/assets/js/2.f69a5113.js" as="script"><link rel="preload" href="/assets/js/21.3d3402c7.js" as="script"><link rel="prefetch" href="/assets/js/10.5c2bb7c0.js"><link rel="prefetch" href="/assets/js/11.a9e937f3.js"><link rel="prefetch" href="/assets/js/12.18e1a8d3.js"><link rel="prefetch" href="/assets/js/13.086c173f.js"><link rel="prefetch" href="/assets/js/14.ba45a4c1.js"><link rel="prefetch" href="/assets/js/15.3332d864.js"><link rel="prefetch" href="/assets/js/16.a62b9621.js"><link rel="prefetch" href="/assets/js/17.df315171.js"><link rel="prefetch" href="/assets/js/18.2a0aea87.js"><link rel="prefetch" href="/assets/js/19.723e65fd.js"><link rel="prefetch" href="/assets/js/20.530ad6f9.js"><link rel="prefetch" href="/assets/js/22.d9c40d56.js"><link rel="prefetch" href="/assets/js/23.f4ca2db8.js"><link rel="prefetch" href="/assets/js/24.42966d79.js"><link rel="prefetch" href="/assets/js/25.acb12a54.js"><link rel="prefetch" href="/assets/js/26.e42497f5.js"><link rel="prefetch" href="/assets/js/27.2a48814c.js"><link rel="prefetch" href="/assets/js/28.b9a1fa55.js"><link rel="prefetch" href="/assets/js/29.fc3b3ec7.js"><link rel="prefetch" href="/assets/js/3.b1eb6805.js"><link rel="prefetch" href="/assets/js/30.8aa1373a.js"><link rel="prefetch" href="/assets/js/31.064b6ef6.js"><link rel="prefetch" href="/assets/js/32.2d7f9391.js"><link rel="prefetch" href="/assets/js/33.da7b40ae.js"><link rel="prefetch" href="/assets/js/34.48af420a.js"><link rel="prefetch" href="/assets/js/35.b5212b6b.js"><link rel="prefetch" href="/assets/js/36.6e4b1ce2.js"><link rel="prefetch" href="/assets/js/37.7815b84c.js"><link rel="prefetch" href="/assets/js/38.22e0cdb1.js"><link rel="prefetch" href="/assets/js/39.467f0eff.js"><link rel="prefetch" href="/assets/js/4.46ad5bf7.js"><link rel="prefetch" href="/assets/js/5.279f05c1.js"><link rel="prefetch" href="/assets/js/6.9361dec1.js"><link rel="prefetch" href="/assets/js/7.3cafae79.js"><link rel="prefetch" href="/assets/js/8.a2fdc4e3.js"><link rel="prefetch" href="/assets/js/9.fe737b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">风痕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  博客首页
</a></div><div class="nav-item"><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues?q=-label%3AGitalk+" target="_self" rel="" class="nav-link external">
  经验随记
  <!----></a></div><div class="nav-item"><a href="https://github.com/hughfenghen" target="_self" rel="" class="nav-link external">
  风痕的GitHub
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端基础课程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-basic-course/js-lang-history-and-basic.html" class="sidebar-link">JS语言历史及基本特性介绍</a></li><li><a href="/fe-basic-course/js-data-process/" class="sidebar-link">JS数据处理</a></li><li><a href="/fe-basic-course/ts-types-system.html" class="sidebar-link">系统化学习 TS 类型系统</a></li><li><a href="/fe-basic-course/js-concurrent.html" aria-current="page" class="active sidebar-link">JS 多线程并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-basic-course/js-concurrent.html#为什么需要并发" class="sidebar-link">为什么需要并发</a></li><li class="sidebar-sub-header"><a href="/fe-basic-course/js-concurrent.html#并发面临的问题" class="sidebar-link">并发面临的问题</a></li><li class="sidebar-sub-header"><a href="/fe-basic-course/js-concurrent.html#js-中如何实现上述两种方法" class="sidebar-link">JS 中如何实现上述两种方法</a></li><li class="sidebar-sub-header"><a href="/fe-basic-course/js-concurrent.html#两个方法对比" class="sidebar-link">两个方法对比</a></li><li class="sidebar-sub-header"><a href="/fe-basic-course/js-concurrent.html#其他" class="sidebar-link">其他</a></li></ul></li><li><a href="/fe-basic-course/https-brief/https-brief.html" class="sidebar-link">HTTPS加密原理简介</a></li><li><a href="/fe-basic-course/options-request.html" class="sidebar-link">Options请求介绍及应对</a></li><li><a href="/fe-basic-course/timer-delay.html" class="sidebar-link">JS 定时器延迟时长细节</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端杂货</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/vuepress-gitment.html" class="sidebar-link">VuePress 集成第三方评论模块</a></li><li><a href="/fe/canvas-lib/" class="sidebar-link">Mini Canvas Lib 核心交互实现原理</a></li><li><a href="/fe/body-mask-danmaku/" class="sidebar-link">Web 端基于机器学习实现防档（不挡脸）弹幕</a></li><li><a href="/fe/js-perf-detect.html" class="sidebar-link">JS 检测设备性能</a></li><li><a href="/fe/react-hooks/" class="sidebar-link">react hooks的思考</a></li><li><a href="/fe/thinking-miniprogram.html" class="sidebar-link">小程序的思考</a></li><li><a href="/fe/modularization/" class="sidebar-link">前端模块化设计</a></li><li><a href="/fe/vue-directive-track.html" class="sidebar-link">基于vue directive实现声明式埋点方案</a></li><li><a href="/fe/bug1-safari10.html" class="sidebar-link">BUG: Safari10 Cannot declare a let variable twice: 'e'.</a></li><li><a href="/fe/sw-ssr/" class="sidebar-link">同构项目 Service Worker 离线化实践</a></li><li><a href="/fe/run-web-project-in-termux.html" class="sidebar-link">在Termux中运行web项目</a></li><li><a href="/fe/debug-hover-element/" class="sidebar-link">调试鼠标悬浮（hover）元素的css技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>clojure</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/clojure/cljs-node-hotreload.html" class="sidebar-link">ClojureScript + node + hotreload</a></li><li><a href="/clojure/cljs-transient-performance.html" class="sidebar-link">cljs中普通与瞬态数据结构性能对比</a></li><li><a href="/clojure/shadow-cljs-proto-repl.html" class="sidebar-link">shadow-cljs项目 在 proto repl 切换namespace</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>随想</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/think/dao.html" class="sidebar-link">天道</a></li><li><a href="/think/biosphere/" class="sidebar-link">生存空间</a></li><li><a href="/think/book-review.html" class="sidebar-link">书评笔记</a></li><li><a href="/think/qin/" class="sidebar-link">为何是秦灭六国，统一天下</a></li><li><a href="/think/interview.html" class="sidebar-link">技术面试中的“运气”指什么</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js-多线程并发"><a href="#js-多线程并发" class="header-anchor">#</a> JS 多线程并发</h1> <h2 id="为什么需要并发"><a href="#为什么需要并发" class="header-anchor">#</a> 为什么需要并发</h2> <p>我们常听说 JS 是单线程模型，即所有代码都在<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Main_thread" target="_blank" rel="noopener noreferrer">主线程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中执行的。<br>
如果某些任务计算量较大，将阻塞主线程，UI 界面轻则掉帧、重则卡死。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 提示：本文所有代理均可复制到浏览器控制台中执行，验证效果</span>

<span class="token comment">// 在任意网页控制台执行以下代码，页面将卡住 3s</span>
<span class="token keyword">function</span> <span class="token function">execTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 模拟耗时任务</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">execTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>所以在计算量大的场景，JS 需要支持并发能力，避免主线程阻塞，影响用户体验。</p> <h2 id="并发面临的问题"><a href="#并发面临的问题" class="header-anchor">#</a> 并发面临的问题</h2> <p>用一个极简化示例，来说明并发面临问题：<br>
10 个线程同时执行 1000 个任务，如何<strong>避免某个任务被重复</strong>执行？</p> <p>方法 1：<br>
任务列表对线程不可见，而是新开一个线程来统一分配任务，并收集其他线程的执行结果。</p> <p>方法 2：<br>
任务列表对所有线程可见（共享内存），线程<strong>先排队去领取任务编号</strong>，然后执行对应编号的任务。</p> <p><em>拓展阅读<a href="https://mp.weixin.qq.com/s/K9gsRxy9idy2_k6Gbmyw9g" target="_blank" rel="noopener noreferrer">并发问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <h2 id="js-中如何实现上述两种方法"><a href="#js-中如何实现上述两种方法" class="header-anchor">#</a> JS 中如何实现上述两种方法</h2> <p>JS 采用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API" target="_blank" rel="noopener noreferrer">Web Worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> API 来实现多线程并发。</p> <p><strong>任务说明：将 1~1000 每个数字求平方（每次随机卡住 0~100ms 模拟耗时任务）</strong></p> <h3 id="分配任务，多-worker-执行"><a href="#分配任务，多-worker-执行" class="header-anchor">#</a> 分配任务，多 Worker 执行</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workerSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 模拟耗时任务,随机消耗时间 0~100ms</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> idx<span class="token punctuation">,</span> val <span class="token punctuation">}</span> <span class="token operator">=</span> evt<span class="token punctuation">.</span>data
    <span class="token comment">// 实际上只是算一下参数的平方</span>
    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      idx<span class="token operator">:</span> idx<span class="token punctuation">,</span>
      val<span class="token operator">:</span> val <span class="token operator">*</span> val
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建一个运行 workerSetup 函数的 worker</span>
<span class="token keyword">const</span> <span class="token function-variable function">createWorker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerSetup<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 模拟 1000 个任务</span>
<span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> rsCount <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">onMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  result<span class="token punctuation">[</span>evt<span class="token punctuation">.</span>data<span class="token punctuation">.</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> evt<span class="token punctuation">.</span>data<span class="token punctuation">.</span>val
  rsCount <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token comment">// 所有任务完成时打印结果</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rsCount <span class="token operator">===</span> tasks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task:'</span><span class="token punctuation">,</span> tasks<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result:'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模拟线程池</span>
<span class="token keyword">const</span> workerPool <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createWorker<span class="token punctuation">)</span>
workerPool<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> onMsg
  worker<span class="token punctuation">.</span>id <span class="token operator">=</span> idx
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> idx <span class="token keyword">in</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 随机分配任务</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> workerPool<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> workerPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> idx<span class="token punctuation">,</span> val<span class="token operator">:</span> tasks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, process task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="多-worker-共享任务（内存）"><a href="#多-worker-共享任务（内存）" class="header-anchor">#</a> 多 Worker 共享任务（内存）</h3> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer" target="_blank" rel="noopener noreferrer">SharedArrayBuffer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是 JS 提供的唯一可在不同线程间共享内存的方式。</p> <blockquote><p>为应对幽灵漏洞，所有主流浏览器均默认于 2018 年 1 月 5 日禁用 SharedArrayBuffer。<br>
在 2020 年，一种新的、安全的方法已经标准化，以重新启用 SharedArrayBuffer。<br>
需要设置两个 HTTP 消息头以跨域隔离你的站点：<br>
Cross-Origin-Opener-Policy: same-origin<br>
Cross-Origin-Embedder-Policy: require-corp</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在浏览器中执行以下代码，请先确保 SharedArrayBuffer 可用。<br>
可复制代码在 <a href="https://live.bilibili.com/3" target="_blank">该页面</a> 的控制台执行测试</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 执行以下代码，预期打印 1000 次 ’process task‘</span>
<span class="token keyword">function</span> <span class="token function">workerSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">execTask</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 模拟耗时任务,随机消耗时间 0~100ms</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> val <span class="token operator">*</span> val
  <span class="token punctuation">}</span>
  self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> idx<span class="token punctuation">,</span> sab <span class="token punctuation">}</span> <span class="token operator">=</span> evt<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> uint16Arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>sab<span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// Atomics.add 模拟排队领取任务</span>
      <span class="token comment">// 如果分成两步（取值、+1）获取任务编号，会出现抢任务的现象（重复执行任务）</span>
      <span class="token comment">// taskNo = uint16Arr[0]; uint16Arr[0] = taskNo + 1</span>
      <span class="token keyword">const</span> taskNo <span class="token operator">=</span> Atomics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>uint16Arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>taskNo <span class="token operator">&gt;=</span> uint16Arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">break</span>
      
      <span class="token comment">// 每个任务写不同的位置，所以不需要原子操作</span>
      uint16Arr<span class="token punctuation">[</span>taskNo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">execTask</span><span class="token punctuation">(</span>uint16Arr<span class="token punctuation">[</span>taskNo<span class="token punctuation">]</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, process task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">createWorker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerSetup<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 第一位存放下一个任务编号， 后面 1000 存放对应任务及结果</span>
<span class="token keyword">const</span> sab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> uint16Arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span>sab<span class="token punctuation">)</span>
uint16Arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> uint16Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uint16Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i 
<span class="token punctuation">}</span>
<span class="token comment">// 模拟线程池，创建 10 个 worker</span>
<span class="token keyword">const</span> workerPool <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createWorker<span class="token punctuation">)</span>

<span class="token keyword">let</span> rsCount <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">onMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  rsCount <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rsCount <span class="token operator">===</span> workerPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result:'</span><span class="token punctuation">,</span> uint16Arr<span class="token punctuation">,</span> sab<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
workerPool<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> onMsg
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> idx<span class="token punctuation">,</span> sab <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Atomics" target="_blank" rel="noopener noreferrer">Atomics<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象提供了一组静态方法对 SharedArrayBuffer 对象进行原子操作。</p></blockquote> <h2 id="两个方法对比"><a href="#两个方法对比" class="header-anchor">#</a> 两个方法对比</h2> <h3 id="方法-1（分配任务）"><a href="#方法-1（分配任务）" class="header-anchor">#</a> 方法 1（分配任务）</h3> <p>处理 1000 个任务，调用了 2000 次（分配任务、反馈结果） postMessage，也就是数据在两个 worker 间传递，经历了 2000 次<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm" target="_blank" rel="noopener noreferrer">结构化克隆<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<br>
通常来说结构化克隆的速度比较快，<a href="https://surma.dev/things/is-postmessage-slow/" target="_blank" rel="noopener noreferrer">影响不大<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>Even on the slowest devices, you can postMessage() objects up to 100KiB and stay within your 100ms response budget. If you have JS-driven animations, payloads up to 10KiB are risk-free. This should be sufficient for most apps.<br>
即使在非常慢的设备上，你也可以使用 postMessage() 传递 100KiB 的对象，可保证在 100 毫秒内响应。如果有用 JS 驱动的动画，那么传递 10KiB 的数据是无风险的。这对于大多数应用程序来说应该足够了。</p></blockquote> <p>另外，部分原生对象是 <a href="https://developer.mozilla.org/en-US/docs/Glossary/Transferable_objects" target="_blank" rel="noopener noreferrer">Transferable objects<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，postMessage(arrayBuffer, [arrayBuffer]) 可以<strong>转移这些对象的所有权，无需clone</strong>，原线程将无法读写被转移所有权的对象。</p> <p>目前实现 Transferrable 的对象有：<code>ArrayBuffer, MessagePort, ReadableStream, WritableStream, TransformStream, AudioData, ImageBitmap, VideoFrame, OffscreenCanvas, RTCDataChannel</code></p> <p><a href="https://github.com/hughfenghen/hughfenghen.github.io/issues/108" target="_blank" rel="noopener noreferrer">Web Worker 传递 ArrayBuffer 时间消耗验证<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，结论：传输 ArrayBuffer 成本几乎可以忽略。</p> <p><strong>所以应优先采用该方法</strong>。</p> <h3 id="方法-2（共享内存）"><a href="#方法-2（共享内存）" class="header-anchor">#</a> 方法 2（共享内存）</h3> <p>共享内存（ SharedArrayBuffer ）节省了线程间通信的消耗，但增加了代码复杂性，只能共享二进制数据，且 SharedArrayBuffer 、Atomics 有一定的兼容性问题。<br>
（目前只看到 WASM 相关的场景用到了 SharedArrayBuffer ）</p> <h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <p>JS 中可在其他线程/进程中执行代码的其他方法。</p> <h3 id="cluster"><a href="#cluster" class="header-anchor">#</a> Cluster</h3> <p><a href="http://nodejs.cn/api/cluster.html#how-it-works" target="_blank" rel="noopener noreferrer">Cluster文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>工作进程使用 child_process.fork() 方法衍生，因此它们可以通过 IPC 与父进程通信并且来回传递服务器句柄。<br>
尽管 node:cluster 模块的主要使用场景是网络，但它也可用于需要工作进程的其他使用场景。</p></blockquote> <p>多进程，一般用于在 Node.js 上运行 WEB 服务器。<br> <a href="https://segmentfault.com/a/1190000014701988" target="_blank" rel="noopener noreferrer">Cluster共享端口有点骚<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="worker-threads"><a href="#worker-threads" class="header-anchor">#</a> worker-threads</h3> <p><a href="http://nodejs.cn/api/worker_threads.html#worker-threads" target="_blank" rel="noopener noreferrer">worker-threads文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
Node.js 上的 Worker 实现。</p> <blockquote><p>worker-threads对于执行 CPU 密集型的 JavaScript 操作很有用。 它们对 I/O 密集型的工作帮助不大。 Node.js 内置的异步 I/O 操作比工作线程更高效。<br>
与 child_process 或 cluster 不同，worker_threads 可通过传输 ArrayBuffer 实例或共享 SharedArrayBuffer 实例来实现共享内存。</p></blockquote> <h3 id="worklet"><a href="#worklet" class="header-anchor">#</a> Worklet</h3> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Worklet" target="_blank" rel="noopener noreferrer">Worklet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>用于特定场景，非通用多线程能力</p> <blockquote><p>Worklet接口是Web Workers的轻量级版本，使开发人员能够访问渲染管道的低级部分。<br>
通过Worklet，你可以运行JavaScript和WebAssembly代码来进行图形渲染或需要高性能的音频处理。</p></blockquote> <ul><li>PaintWorklet 自定义 css 绘制行为</li> <li>AudioWorklet 用于自定义AudioNodes的音频处理</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-basic-course/ts-types-system.html" class="prev">
        系统化学习 TS 类型系统
      </a></span> <span class="next"><a href="/fe-basic-course/https-brief/https-brief.html">
        HTTPS加密原理简介
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdd650a.js" defer></script><script src="/assets/js/2.f69a5113.js" defer></script><script src="/assets/js/21.3d3402c7.js" defer></script>
  </body>
</html>
