---
tags:
  - 音视频
  - WebCodecs
  - WebAV
date: 2024-07-09
---

# 纯 Web 实现视频剪辑产品

## 前言

WebCodecs API 为 Web 平台提供了音视频编解码能力，因此在 Web 平台（网页、Electron）上实现高效、专业的视频剪辑成品成为可能。

<!-- link -->

读者可通过笔者的[系列文章][1]，了解 Webcodecs API 和 Web 音视频基础知识。

## 业务背景 & 方案分析

为了解决主播投稿场景中，需要对直播视频进行简单编辑的诉求，我们需要开发一款轻量视频剪辑产品。
让用户能在线上完成 直播 - 编辑 - 投稿 流程。

<!-- 其他产品 -->
<!-- 分析主流直播平台，剪辑功能 -->

现有的方案关于视频处理的实现

<!-- 现有剪辑技术方案 -->

|        | 云端 | ffmpeg.wasm | Webcodecs |
| ------ | ---- | ----------- | --------- |
| 成本   | 差   | 优          | 优        |
| 生态   | 优   | 中          | 差        |
| 扩展性 | 中   | 差          | 优        |
| 兼容性 | 优   | 优          | 差        |
| 性能   | 中   | 差          | 优        |

ffmpeg -i sintel-2048-surround.mp4 -vf "drawtext=text='Test Text':fontcolor=white:fontsize=24:x=(w-text_w)/2:y=(h-text_h)/2" -codec:a copy output.mp4
4:30, 3.3x

<!-- 性能对比 1080P，其他产品 -->

如题，我们选择了 WebCodecs（纯 Web）

### 方案分析

Webcodecs 方案在**成本与扩展性**方面有明显的优势，生态成熟度、兼容性则略显不足；  
云端方案是当前主流选择，如果项目成本预算足够正好可以与 WebCodecs 互补；  
ffmpeg.wasm 因性能太差，无法应用。

**Webcodecs 方案**

- 成本：只需要少量 Web 开发即可完成前端剪辑功能，节省开发成本的同时，降低了技术复杂性，且不需要服务器运行、维护成本
- 扩展性：能轻松与 Canvas、WebAudio 配合，实现自定义功能
- 生态成熟度：没有直接可用的转场、滤镜、特效等功能，支持的封装格式有限
- 兼容性：Chrome/Edge 102+

结合产品定位（轻量剪辑工具）与用户特征（主播），对缺点包容性较高，且缺点并非硬性阻碍

- 生态不成熟并非能力限制，所以是开发成本问题，已有功能已能满足当前产品的需要
- 兼容性其实是时间问题；当前做好提示，引导用户升级浏览器版本即可

## 功能分析

<!-- 产品截图，重点功能举例介绍 -->

开发一个剪辑产品，只需要三个步骤

1. 实现素材管理模块
2. 实现画布模块
3. 实现时间轴模块

每个模块下都包含许多小功能，比如获取封面、预览播放、分割素材，最终都可以拆解成以下基础能力

- 素材加载、存储
- 素材解析
- 视频寻帧、遍历帧
- 原始图像、音频数据处理
- 素材空间、时间属性设置

接下来介绍这些基础能力的实现原理，相信认真阅读完的读者，从零实现一个纯 Web 剪辑产品也并非难事。

## 基础能力实现

<!-- 流程图 -->

### 素材加载、存储

音视频素材体积一般都比较大，上传下载都有一定的时间、带宽成本。

以前在 Web 平台读写文件有很多限制，现在可借助 OPFS API 将素材存储在浏览器的私有文件系统中，使用方便，能较大提升用户体验。

详情可阅读 xxx

### 素材解析

我们都知道视频是由一系列图片组成的，图片上的像素点即是原始数据；  
音视频原始数据量非常庞大，为了方便存储、在网络中传播，需要将原始数据压缩、封装成常见的音视频文件。

<!-- 图、视频图像帧 -->

音视频文件的构建过程是这样的：

1. 将图像帧压缩后成组（时间上连续的图像往往非常相似，**成组压缩率更高**）
2. 多个帧组再加上描述信息，构成音视频文件

<!-- 示意图 -->

处理音视频数据的第一步就是解析文件，目的是得到音视频原始数据，反向构建过程即可

`视频文件 -> 解封装 -> 压缩帧 -> 解码 -> 原始数据`

- 使用第三方库（如 mp4box.js）解封装视频文件，得到 压缩帧
- 使用 WebCodecs API 解码压缩帧得到原始数据

_了解更多详情可阅读[在浏览器中解析视频][3]_

### 视频寻帧、遍历帧

因为视频文件体积通常比较大，不可能全部加载到内存中，所以一般是按需从磁盘读取数据然后解码。

比如需要为视频第 10 ～ 20s 的图像嵌入水印

1. 寻找到 10s ~ 20s 的帧在文件中的位置
2. 从磁盘读取对应的帧然后解码，得到原始图像
3. 在图像上绘制文字，然后重新编码生成新的压缩帧

以上可知，寻帧、然后流式遍历帧是音视频处理的基础。

前文提到视频文件的帧是成组的，所以寻帧、解码也需要按组处理。

<!-- 分组图 -->

比如：期望解码得到第 10s 的帧，该帧属于 A 组，那实际需要解码 A 组所有的 Chunk

_注：此处简化了分组概念，实际情况略复杂些，组内的帧分不同类型_

了解更多详情可阅读[视频截帧][4]

### 图像处理

了解了上述的知识点，现在已经可以随意读取或遍历视频文件的所有图像帧了

<!-- 滤镜、特效、绿幕抠图、人脸识别 -->

### 空间、时间属性

**空间属性**指素材的坐标、大小、旋转角度

导出视频时，根据时间获取素材的的图像帧，动态设置当前时刻图像帧的空间属性，即可实现动画效果

比如，一个图片素材的平移动画（0s ～ 1s，坐标 x 10 ～ 100），0.5s 时素材图像帧坐标为 `x = (100 - 10) * (0.5 / 1)`。

**时间属性**指素材在视频中出现的时间偏移、持续时间

用这两个属性可描述素材在视频时间轴上的位置

## 总结

1. 了解以上基础能力的原理，再加上些许耐心与时间就能实现视频剪辑的大多数功能了
2. 以上的基础能力除了剪辑场景外，还能应用于端上的视频批量处理、直播推流、播放能力增强等场景
3. 在 Web 平台处理音视频仍有许多细节，以及需配合大量的其他 API，继续探索建议阅读[系列文章][x]、使用我们开源的 [WebAV SDK][x]。

## 附录

- [WebAV][x]: 在 Web 平台创建/编辑音视频文件的 SDK
- [FFCreator][2]
- [在浏览器中解析视频][3]
- [视频截帧][4]

[1]: https://hughfenghen.github.io/tag/WebAV/
[2]: https://tnfe.github.io/FFCreator/#/README?id=原理简介
[3]: https://hughfenghen.github.io/posts/2023/07/23/webav-2-parse-video/
[4]: https://www.bilibili.com/read/cv30358687/

---

1.  素材加载（粗剪）
2.  封面
3.  缓存
    1. 调整素材位置、缩放、旋转
4.  预览播放
    1. 调整素材时间
5.  缩略图
6.  分割素材

<!-- 编解码流程图片 -->

拆解功能，映射到能力

## 数据处理流程

## 基础能力

解析文件是第一步，
寻帧是核心

基础能力实现原理

WebAV

方案选择参考 [ffcreator][2] 的总结

> 大多数视频处理通常离不开 FFmpeg 这个库，虽然 FFmpeg 在视频处理方面具有十分强大的功能。 但是在处理精细的动画效果方面 FFmpeg 就显得力不从心，并且它的使用也很不方便，需要开发去拼接大段的命令行参数。

<!-- 跨平台：支持在 Edge、Chrome 浏览器，以及 Electron 中运行
体积小：约 50kb（MINIFIED + GZIPPED, 未 tree-shaking） -->

<!-- 接下来剪辑产品主要功能是如何实现的， -->

若读者想了解能力 关于基础能力

- 纯 Web 视频剪辑原理
  - 业务背景、方案调研分析
    - 方案对比：服务端方案、浏览器方案
      - 维度：生态成熟度，扩展灵活性，兼容性，开发成本（方案复杂度），运行成本
      - 结合 用户特征（主播）、产品特性（轻量）
  - Web 音视频数据处理流程
    - 视频 - 帧（图像） - 处理（canvas/WebGL） - 新帧 - 视频
    - 音频 - PCM - 处理（WebAudio） - 新 PCM - 音频
  - 基础能力
    - 加载、解析视频
    - 遍历帧、寻帧
    - 设置素材空间、时间属性
    - 图像处理、音频处理
  - 主要功能原理：预览播放、素材管理、时间轴
  - 其他功能原理：贴纸、滤镜、转场、特效
  - 边界 case
